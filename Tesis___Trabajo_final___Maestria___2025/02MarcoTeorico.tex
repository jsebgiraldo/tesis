\chapter{Marco Teórico}

\section{Fundamentos de Redes Smart Energy}

\subsection{Evolución de las Infraestructuras Eléctricas}

La transición de redes eléctricas tradicionales unidireccionales hacia Smart Grids bidireccionales representa un cambio paradigmático en la operación de sistemas energéticos~\cite{velasquezSmartGridsEmpowered2024,alsafranChallengesImplementingIoT2025}. Las Smart Grids integran tecnologías de información y comunicación (TIC) para monitoreo, control y optimización en tiempo real del flujo eléctrico desde generación hasta consumo final~\cite{SmartHomeEnergy2024}. Este enfoque permite: integración masiva de energías renovables distribuidas (DER - Distributed Energy Resources), gestión activa de la demanda (DSM - Demand Side Management), detección y auto-recuperación de fallas (self-healing), y participación activa de prosumidores (consumidores que también generan energía).

Según el National Institute of Standards and Technology (NIST), una Smart Grid implementa siete dominios interconectados: Bulk Generation, Transmission, Distribution, Customer, Operations, Markets, y Service Provider~\cite{IEEERecommendedPractice}. La infraestructura de medición inteligente (AMI - Advanced Metering Infrastructure) constituye el dominio Customer, proporcionando visibilidad granular de patrones de consumo y habilitando servicios de respuesta a la demanda (DR).

\subsection{Arquitectura de Referencia Smart Grid}

El modelo de referencia NIST para Smart Grid (NIST Framework and Roadmap for Smart Grid Interoperability Standards) define tres capas principales~\cite{alsuwaidiSecuringSmartGrid2024}:

\begin{enumerate}
\item \textbf{Power and Energy Layer}: Infraestructura física de generación, transmisión, distribución y almacenamiento.
\item \textbf{Communication Layer}: Redes de datos multi-protocolo (HAN, NAN, WAN) que transportan información de telemetría y comandos de control.
\item \textbf{Application Layer}: Sistemas de gestión de energía (EMS), gestión de distribución (DMS), gestión de demanda (DERMS), y analytics.
\end{enumerate}

La arquitectura AMI se compone típicamente de: medidores inteligentes (smart meters) instalados en puntos de consumo, concentradores/gateways que agregan datos de decenas o cientos de medidores, y head-end systems en centros de control que procesan millones de registros diarios.

\section{Stack de Protocolos 6LoWPAN para IoT}

Antes de analizar los protocolos individuales, es fundamental comprender la arquitectura completa del stack de comunicación propuesto para redes IoT en Smart Energy. El stack se construye sobre la base de IEEE 802.15.4 y utiliza 6LoWPAN como capa de adaptación para transportar IPv6 sobre redes de sensores con restricciones de recursos.

\subsection{Visión General del Stack}

El stack de protocolos integra múltiples capas del modelo OSI, optimizando cada capa para operar en entornos constrained (dispositivos con <256 KB RAM, <1 MB Flash, batería limitada):

\begin{table}[h]
\centering
\small
\caption{Stack de protocolos 6LoWPAN/CoAP/LwM2M para IoT Smart Energy}
\label{tab:protocol-stack}
\begin{tabular}{|p{2.5cm}|p{3.5cm}|p{6.5cm}|}
\hline
\rowcolor{gray!20}
\textbf{Capa OSI} & \textbf{Protocolo} & \textbf{Función Principal} \\
\hline
\textbf{7. Aplicación} & \textcolor{blue}{LwM2M 1.2} & Gestión dispositivos, objetos IPSO telemetría \\
\hline
\textbf{6. Presentación} & CBOR/TLV & Serialización eficiente binaria \\
\hline
\textbf{5. Sesión} & \textcolor{blue}{CoAP RFC 7252} & RESTful para constrained devices \\
\hline
\textbf{4. Transporte} & UDP & No orientado a conexión \\
\hline
\textbf{3. Red} & \textcolor{blue}{6LoWPAN RFC 6282} & Compresión IPv6 headers, fragmentación \\
\hline
\textbf{3. Red} & IPv6 & Direccionamiento global end-to-end \\
\hline
\textbf{2. Enlace (MAC)} & IEEE 802.15.4 MAC & CSMA/CA, ACKs, retransmisiones \\
\hline
\textbf{1. Física} & IEEE 802.15.4 PHY & 2.4 GHz OQPSK, 250 kbps \\
\hline
\end{tabular}
\end{table}

\subsection{Flujo de Datos en el Stack}

El flujo de un mensaje de telemetría desde un sensor hasta el servidor sigue la siguiente secuencia de transformaciones:

\textbf{Transmisión (Device → Gateway):}
\begin{enumerate}
\item \textbf{Aplicación}: Sensor genera lectura (temperatura 23.5°C, humedad 65\%), LwM2M codifica en TLV binario (~12 bytes).
\item \textbf{CoAP}: Encapsula payload en mensaje CoAP POST, agrega header (4-10 bytes), marca como NON-confirmable para telemetría no crítica.
\item \textbf{UDP}: Agrega header UDP (8 bytes) con puertos origen/destino (5683 por defecto para CoAP).
\item \textbf{IPv6}: Construye header IPv6 completo (40 bytes) con direcciones origen/destino globales.
\item \textbf{6LoWPAN}: Aplica compresión IPHC reduciendo header IPv6 de 40 bytes a 2-7 bytes, y NHC comprimiendo UDP de 8 bytes a 4 bytes. Total header comprimido: ~6-11 bytes vs 52 bytes sin comprimir (reducción 80-90\%).
\item \textbf{IEEE 802.15.4}: Fragmenta si payload excede MTU (127 bytes), agrega header MAC (25 bytes), FCS (2 bytes), transmite frame a 250 kbps.
\end{enumerate}

\textbf{Recepción (Gateway → Device):}
\begin{enumerate}
\item \textbf{IEEE 802.15.4}: Valida FCS, envía ACK si frame dirigido a este nodo, reensambl fragmentos.
\item \textbf{6LoWPAN}: Descomprime headers IPHC/NHC reconstruyendo IPv6+UDP completos.
\item \textbf{IPv6/UDP}: Routing a socket CoAP (puerto 5683).
\item \textbf{CoAP}: Parsea request, ejecuta handler de recurso, genera response.
\item \textbf{LwM2M}: Decodifica TLV, actualiza objeto IPSO en memoria, notifica a observadores si cambio significativo.
\end{enumerate}

\subsection{Ventajas del Stack 6LoWPAN}

\textbf{Eficiencia de Bandwidth}: Compresión IPHC/NHC reduce overhead de headers de 52 bytes (IPv6+UDP) a ~6-11 bytes, permitiendo payloads útiles de 100-110 bytes en frames 802.15.4 de 127 bytes (eficiencia >75\%).

\textbf{Interoperabilidad IPv6}: Uso de direcciones IPv6 globales permite comunicación directa entre dispositivos IoT y sistemas backend sin traducción de protocolos (NAT-free).

\textbf{Fragmentación Transparente}: 6LoWPAN maneja fragmentación/reensamblado de paquetes IPv6 grandes (>127 bytes) sin requerir soporte en capas superiores.

\textbf{Mesh Routing}: Soporta mesh-under (routing en capa 2) y route-over (routing en capa 3 IPv6) para topologías multi-hop.

\textbf{Seguridad End-to-End}: CoAP sobre DTLS 1.2 proporciona cifrado, autenticación y integridad de mensajes sin depender de seguridad en capa MAC.

Esta arquitectura de stack será la base conceptual para los análisis detallados de cada protocolo en las siguientes secciones.

\section{Protocolos de Comunicación IoT}

\subsection{Thread 802.15.4 - Redes Mesh de Baja Potencia}

Thread es un protocolo de red IPv6 basado en IEEE 802.15.4, diseñado específicamente para aplicaciones IoT domésticas e industriales de baja potencia~\cite{abdulsalamOverviewRecentWireless2024}. Desarrollado por Thread Group (ahora parte de Connectivity Standards Alliance), estandariza la capa de red y transporte sobre la capa física/MAC 802.15.4, proporcionando routing mesh, auto-configuración y seguridad end-to-end~\cite{choudharyInternetThingsComprehensive2024}.

\subsubsection{Arquitectura del Protocolo Thread}

Thread implementa un stack de protocolos completo sobre IEEE 802.15.4~\cite{aliyuWirelessCommunicationProtocols2025}:

\begin{itemize}
\item \textbf{Physical Layer (PHY)}: IEEE 802.15.4-2015, banda 2.4 GHz, OQPSK modulation, 250 kbps data rate, 16 canales (11-26).
\item \textbf{MAC Layer}: CSMA/CA con backoff exponencial, frame acknowledgments, retransmisiones automáticas.
\item \textbf{Network Layer}: 6LoWPAN (IPv6 over Low-Power Wireless Personal Area Networks) - compresión de headers IPv6, fragmentación, mesh-under routing~\cite{abood6LoWPANTechnicalFeatures2024}.
\item \textbf{Transport Layer}: UDP (principalmente), TCP limitado por overhead.
\item \textbf{Application Layer}: CoAP (Constrained Application Protocol), MQTT-SN, LwM2M~\cite{karimiIIoTCommunicationProtocols2025}.
\end{itemize}

El routing Thread utiliza Mesh Link Establishment (MLE) para descubrimiento de vecinos y mantenimiento de tabla de rutas. Cada dispositivo mantiene una tabla con métricas de link quality (LQI - Link Quality Indicator) y path cost hacia el líder de la red. El protocolo implementa route optimization continuo basado en Expected Transmission Count (ETX).

\subsubsection{Thread Border Router (OTBR)}

El Thread Border Router (OTBR) actúa como gateway entre la red Thread (802.15.4) y redes IP tradicionales (Ethernet, Wi-Fi), proporcionando:

\begin{itemize}
\item \textbf{Traducción IPv6}: Routing entre prefijos Thread (mesh-local) y prefijos globales.
\item \textbf{NAT64/DNS64}: Interoperabilidad con servicios IPv4-only.
\item \textbf{Multicast forwarding}: Propagación de mensajes multicast entre segmentos.
\item \textbf{Commissioning}: Incorporación segura de nuevos dispositivos mediante out-of-band authentication.
\end{itemize}

La implementación de referencia OpenThread Border Router (OTBR) soporta dos arquitecturas: System-on-Chip (SoC) donde un único MCU ejecuta stack Thread y aplicación, o Radio Co-Processor (RCP) donde un MCU dedicado (ej. nRF52840) implementa PHY/MAC y un host Linux ejecuta capas superiores.

\subsubsection{Arquitectura de Routing Thread - Análisis Profundo}

Thread implementa un protocolo de routing mesh adaptativo basado en métricas de calidad de enlace y costo de path. La topología se organiza jerárquicamente en roles de dispositivo:

\begin{itemize}
\item \textbf{Leader}: Único nodo elegido que gestiona asignación de Router IDs y mantiene información de red (Network Data).
\item \textbf{Router}: Nodos full-function que forwardean paquetes y mantienen tabla de rutas completa.
\item \textbf{Router Eligible End Device (REED)}: Dispositivos que pueden promover a Router si la topología lo requiere.
\item \textbf{End Device}: Nodos leaf sin capacidad de routing, se comunican únicamente con su Parent Router.
\end{itemize}

La tabla de routing Thread almacena para cada destino:

\begin{table}[h]
\centering
\small
\caption{Ejemplo de tabla de routing Thread para Smart Energy}
\label{tab:thread-routing}
\begin{tabular}{|p{2.8cm}|p{2.5cm}|p{2.2cm}|p{1.8cm}|p{2cm}|}
\hline
\rowcolor{gray!20}
\textbf{Destination} & \textbf{Next Hop} & \textbf{Path Cost} & \textbf{LQI} & \textbf{Age (s)} \\
\hline
Router 2 & Direct & \textcolor{green}{1} & \textcolor{blue}{255} & 0 \\
\hline
Router 5 & Router 2 & 2 & \textcolor{blue}{220} & 5 \\
\hline
End Device 12 & Router 2 & 2 & 200 & 3 \\
\hline
Leader & Router 2 & 2 & \textcolor{blue}{255} & 1 \\
\hline
\end{tabular}
\end{table}

El algoritmo de selección de ruta considera:

\begin{equation}
\text{Path Cost} = \sum_{i=1}^{n} \frac{100}{\text{LQI}_i}
\end{equation}

donde LQI (Link Quality Indicator) toma valores 0-255, con 255 representando calidad óptima. Thread actualiza rutas periódicamente mediante MLE Advertisement frames (intervalo típico 32 segundos).

Comparativa con otros protocolos mesh 2.4 GHz:

\begin{table}[h]
\centering
\small
\caption{Comparación de protocolos mesh 2.4 GHz para Smart Energy}
\label{tab:mesh-protocols-detailed}
\begin{tabular}{|p{3.2cm}|p{3.2cm}|p{3.2cm}|p{3.2cm}|}
\hline
\rowcolor{gray!20}
\textbf{Característica} & \textbf{Thread 1.3.1} & \textbf{Zigbee 3.0} & \textbf{Bluetooth Mesh} \\
\hline
\textbf{Stack routing} & \textcolor{blue}{IPv6 6LoWPAN} & \textcolor{red}{Propietario AODV} & \textcolor{red}{Managed Flooding} \\
\hline
\textbf{Hop limit} & \textcolor{blue}{No limit (3-5 típico)} & 30 máx. & 127 máx. \\
\hline
\textbf{Route repair} & \textcolor{blue}{Proactive MLE} & \textcolor{red}{Reactive AODV RERR} & \textcolor{red}{Flooding redundancy} \\
\hline
\textbf{Commissioning} & Out-of-band PSKd & Install codes & Provisioning ECDH \\
\hline
\textbf{Border Router} & \textcolor{blue}{Estándar OTBR} & \textcolor{red}{Coordinador específico} & \textcolor{red}{Proxy nodes} \\
\hline
\textbf{Matter compatibility} & \textcolor{blue}{Nativo} & \textcolor{red}{Requiere bridge} & \textcolor{red}{Requiere bridge} \\
\hline
\end{tabular}
\end{table}

\subsection{6LoWPAN - Compresión IPv6 para Redes Constrained}

6LoWPAN (IPv6 over Low-Power Wireless Personal Area Networks), definido en RFC 6282 y RFC 4944, es una capa de adaptación que permite la transmisión de paquetes IPv6 sobre redes IEEE 802.15.4, superando la limitación del MTU de 127 bytes mediante compresión de headers y fragmentación~\cite{shelby6LoWPANWirelessEmbedded2009,thungonSurvey6LoWPANSecurity2024}.

\subsubsection{Motivación de 6LoWPAN}

El stack IPv6 tradicional presenta overhead prohibitivo para redes de sensores~\cite{mamoImplementationStandardized6LoWPAN2015}:
\begin{itemize}
\item \textbf{Header IPv6}: 40 bytes (31.5\% del MTU 802.15.4)
\item \textbf{Header UDP}: 8 bytes (6.3\% del MTU)
\item \textbf{Total headers sin compresión}: 48 bytes (37.8\% del MTU)
\item \textbf{Payload disponible}: 79 bytes (62.2\% del MTU)
\end{itemize}

Esta ineficiencia se agrava en topologías mesh donde cada retransmisión consume energía preciosa en dispositivos battery-powered.

\subsubsection{Compresión IPHC (IPv6 Header Compression)}

6LoWPAN implementa compresión IPHC (RFC 6282) que reduce headers IPv6 de 40 bytes a 2-7 bytes explotando redundancias contextuales:

\textbf{1. Compresión de Direcciones IPv6:}
\begin{itemize}
\item \textbf{Link-local addresses}: Derivadas de dirección MAC 802.15.4 (64 bits), se omiten completamente (compresión 16 bytes → 0 bytes).
\item \textbf{Multicast addresses}: Prefijos conocidos (ff02::/16) se comprimen a 1-6 bytes.
\item \textbf{Context-based compression}: Prefijos de red conocidos (ej. fd00::/64 de red Thread) se referencian por ID de contexto de 4 bits.
\end{itemize}

\textbf{2. Compresión de Campos IPv6:}
\begin{itemize}
\item \textbf{Version (4 bits)}: Siempre 6, se omite.
\item \textbf{Traffic Class (8 bits)}: Típicamente 0, se omite si no usado.
\item \textbf{Flow Label (20 bits)}: Se omite si 0.
\item \textbf{Hop Limit (8 bits)}: Se comprime a 2 bits si valor ≤64.
\end{itemize}

\textbf{Ejemplo de compresión IPHC:}

\begin{table}[h]
\small
\centering
\caption{Compresión IPHC de Header IPv6 para Smart Energy IoT}
\label{tab:iphc-compression}
\begin{tabular}{p{3cm}p{2.5cm}p{2.8cm}p{2.2cm}}
\hline
\rowcolor{gray!20}
\textbf{Campo IPv6} & \textbf{Original (bytes)} & \textbf{Comprimido (bytes)} & \textbf{Reducción (\%)} \\
\hline
Version + TC + FL & 4 & \textcolor{blue}{0} & \textcolor{green}{100\%} \\
\hline
Payload Length & 2 & \textcolor{blue}{0 (implícito 802.15.4)} & \textcolor{green}{100\%} \\
\hline
Next Header & 1 & \textcolor{blue}{0 (UDP NHC)} & \textcolor{green}{100\%} \\
\hline
Hop Limit & 1 & 0-1 & 0-100\% \\
\hline
Source Address & 16 & \textcolor{blue}{0-2 (link-local)} & \textcolor{green}{87.5-100\%} \\
\hline
Dest Address & 16 & \textcolor{blue}{0-2 (link-local)} & \textcolor{green}{87.5-100\%} \\
\hline
\textbf{Total IPv6} & \textbf{40} & \textbf{\textcolor{yellow}{2-7}} & \textbf{\textcolor{yellow}{82.5-95\%}} \\
\hline
\end{tabular}
\end{table}

\subsubsection{Compresión NHC (Next Header Compression)}

NHC extiende compresión a headers de capa de transporte (UDP) y aplicación (CoAP):

\textbf{UDP Header Compression (RFC 6282):}
\begin{itemize}
\item \textbf{Ports}: Si puertos origen/destino en rango 61616-61631 (CoAP typical), se comprimen de 4 bytes a 1 byte.
\item \textbf{Length}: Se omite (inferido de frame 802.15.4).
\item \textbf{Checksum}: Se reemplaza por checksum 802.15.4 o se omite en enlaces confiables.
\end{itemize}

\begin{table}[h]
\small
\centering
\caption{Compresión NHC de Header UDP para Smart Energy CoAP}
\label{tab:nhc-udp}
\begin{tabular}{p{3cm}p{2.5cm}p{2.8cm}p{2.2cm}}
\hline
\rowcolor{gray!20}
\textbf{Campo UDP} & \textbf{Original (bytes)} & \textbf{Comprimido (bytes)} & \textbf{Reducción (\%)} \\
\hline
Source Port & 2 & \textcolor{blue}{0.5 (4 bits)} & \textcolor{green}{75\%} \\
\hline
Dest Port & 2 & \textcolor{blue}{0.5 (4 bits)} & \textcolor{green}{75\%} \\
\hline
Length & 2 & \textcolor{blue}{0} & \textcolor{green}{100\%} \\
\hline
Checksum & 2 & \textcolor{blue}{0} & \textcolor{green}{100\%} \\
\hline
\textbf{Total UDP} & \textbf{8} & \textbf{\textcolor{yellow}{1-2}} & \textbf{\textcolor{yellow}{75-87.5\%}} \\
\hline
\end{tabular}
\end{table}

\textbf{Compresión Total IPv6+UDP:}
\begin{equation}
\text{Overhead comprimido} = 2\text{-}7 \text{ (IPHC)} + 1\text{-}2 \text{ (NHC-UDP)} = 3\text{-}9 \text{ bytes}
\end{equation}

\begin{equation}
\text{Payload disponible} = 127 - 25 \text{ (MAC header)} - 3\text{-}9 \text{ (IPHC+NHC)} = 93\text{-}99 \text{ bytes (73-78\% del MTU)}
\end{equation}

vs 79 bytes (62\%) sin compresión → **Ganancia 14-16 bytes (18-20\% más payload)**.

\subsubsection{Fragmentación y Reensamblado}

Cuando payload IPv6 excede MTU 802.15.4 (incluso con compresión), 6LoWPAN fragmenta en múltiples frames:

\begin{itemize}
\item \textbf{First Fragment}: Contiene header de fragmentación (4 bytes: datagram\_size, datagram\_tag) + primeros N bytes de payload.
\item \textbf{Subsequent Fragments}: Header de fragmentación (5 bytes: datagram\_size, datagram\_tag, datagram\_offset) + siguientes N bytes.
\end{itemize}

\textbf{Limitaciones de Fragmentación:}
\begin{itemize}
\item Aumenta latencia (espera de todos los fragmentos).
\item Reduce confiabilidad (pérdida de 1 fragmento = descarte de datagrama completo).
\item Consume buffers en receptor (reensamblado requiere RAM para almacenar fragmentos parciales).
\end{itemize}

\textbf{Best Practice:} Diseñar payloads de aplicación ≤70 bytes para evitar fragmentación en topologías mesh (headers Thread/6LoWPAN/UDP consumen ~25-30 bytes).

\subsubsection{Impacto de 6LoWPAN en Latencia}

Análisis empírico de latencia por hop con/sin compresión 6LoWPAN:

\begin{table}[h]
\small
\centering
\caption{Latencia por Hop con/sin Compresión 6LoWPAN para Smart Energy}
\label{tab:6lowpan-latency}
\begin{tabular}{p{4cm}p{2.8cm}p{2.8cm}p{2cm}}
\hline
\rowcolor{gray!20}
\textbf{Escenario Mesh Thread} & \textbf{Sin Compresión} & \textbf{Con IPHC+NHC} & \textbf{Reducción} \\
\hline
TX @ 250 kbps (headers) & 1.54 ms (48B) & \textcolor{blue}{0.29 ms (7B)} & \textcolor{green}{81\%} \\
\hline
Procesamiento & 0 ms & 0.15 ms & — \\
\hline
Total por hop & 1.54 ms & \textcolor{blue}{0.44 ms} & \textcolor{green}{71\%} \\
\hline
\textbf{Latencia 5 hops} & \textbf{7.7 ms} & \textbf{\textcolor{yellow}{2.2 ms}} & \textbf{\textcolor{yellow}{71\%}} \\
\hline
\end{tabular}
\end{table}

La compresión 6LoWPAN reduce latencia en topologías mesh multi-hop en >70\%, crítico para aplicaciones Smart Energy con requisitos de tiempo real (<100 ms).

\subsection{CoAP - Protocolo de Aplicación para Dispositivos Constrained}

CoAP (Constrained Application Protocol, RFC 7252) es un protocolo web RESTful optimizado para dispositivos IoT con recursos limitados, diseñado como alternativa ligera a HTTP~\cite{shahinzadehSmartHomeConnectivity2024,hossainComparativeStudyIoTCommunication2018}.

\subsubsection{Características Fundamentales de CoAP}

\begin{itemize}
\item \textbf{Arquitectura RESTful}: Métodos GET/POST/PUT/DELETE sobre recursos identificados por URIs (ej. \texttt{coap://sensor01/temp})~\cite{singhNextGenerationProtocolsEnhanced2023}.
\item \textbf{Transporte UDP}: Overhead mínimo 8 bytes vs 20+ bytes TCP + handshake de 3 vías.
\item \textbf{Header compacto}: 4 bytes fijos vs 100+ bytes HTTP.
\item \textbf{Mensajes binarios}: Parsing eficiente vs texto HTTP (sin necesidad de string parsing).
\item \textbf{Modos CON/NON}: Confirmable (con ACK) para comandos críticos, Non-Confirmable para telemetría best-effort~\cite{karimiIIoTCommunicationProtocols2025}.
\item \textbf{Observe (RFC 7641)}: Subscripciones a recursos para notificaciones push (vs polling HTTP).
\item \textbf{Block-wise Transfer (RFC 7959)}: Transferencia de payloads grandes en bloques (crítico para firmware OTA).
\item \textbf{DTLS integrado}: Seguridad con overhead menor que TLS/TCP.
\end{itemize}

\subsubsection{Estructura de Mensaje CoAP}

\begin{verbatim}
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Ver| T |  TKL  |      Code     |          Message ID           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   Token (if any, TKL bytes) ...
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   Options (if any) ...
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|1 1 1 1 1 1 1 1|    Payload (if any) ...
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
\end{verbatim}

\textbf{Campos del Header (4 bytes fijos):}
\begin{itemize}
\item \textbf{Ver (2 bits)}: Versión CoAP (siempre 01 para CoAP/1).
\item \textbf{T (2 bits)}: Tipo de mensaje (CON, NON, ACK, RST).
\item \textbf{TKL (4 bits)}: Token Length (0-8 bytes para correlación request/response).
\item \textbf{Code (8 bits)}: Método (0.01=GET, 0.02=POST, 0.03=PUT, 0.04=DELETE) o Response Code (2.05=Content, 4.04=Not Found).
\item \textbf{Message ID (16 bits)}: Identificador único para detección de duplicados.
\end{itemize}

\subsubsection{CoAP vs HTTP - Análisis Comparativo}

\begin{table}[h]
\centering
\small
\caption{Comparación CoAP vs HTTP para dispositivos constrained}
\label{tab:coap-vs-http}
\begin{tabular}{|p{3.5cm}|p{4cm}|p{4cm}|}
\hline
\rowcolor{gray!20}
\textbf{Característica} & \textbf{CoAP/UDP} & \textbf{HTTP/TCP} \\
\hline
\textbf{Header mínimo} & \textcolor{blue}{4 bytes} & \textcolor{red}{100+ bytes (típico 200-500)} \\
\hline
\textbf{Transporte} & \textcolor{blue}{UDP (8 bytes)} & \textcolor{red}{TCP (20 bytes + handshake)} \\
\hline
\textbf{Overhead total} & \textcolor{blue}{12-30 bytes} & \textcolor{red}{120-520 bytes} \\
\hline
\textbf{Latencia conexión} & \textcolor{green}{0 ms (stateless)} & \textcolor{red}{50-150 ms (3-way handshake)} \\
\hline
\textbf{Formato} & \textcolor{blue}{Binario (parsing rápido)} & \textcolor{red}{Texto (parsing lento)} \\
\hline
\textbf{Subscripciones} & \textcolor{blue}{Observe (push nativo)} & \textcolor{red}{Polling o WebSocket} \\
\hline
\textbf{Fragmentación} & \textcolor{blue}{Block-wise (CoAP-aware)} & \textcolor{red}{TCP segmentation (opaco)} \\
\hline
\textbf{Multicast} & \textcolor{blue}{Sí (UDP nativo)} & \textcolor{red}{No (TCP unicast only)} \\
\hline
\textbf{Seguridad} & \textcolor{blue}{DTLS (menor overhead)} & \textcolor{red}{TLS (mayor overhead)} \\
\hline
\end{tabular}
\end{table}

\textbf{Ejemplo de GET Request:}

\textit{CoAP:}
\begin{verbatim}
GET coap://10.0.0.1/sensor/temp
Header: 4 bytes + Token: 2 bytes + URI-Path options: 12 bytes = 18 bytes total
\end{verbatim}

\textit{HTTP:}
\begin{verbatim}
GET /sensor/temp HTTP/1.1
Host: 10.0.0.1
User-Agent: curl/7.68.0
Accept: */*

Total: ~120 bytes (6.7× más overhead)
\end{verbatim}

\subsubsection{Modos de Confiabilidad CoAP}

\textbf{1. Confirmable (CON):} Requiere ACK del receptor, con retransmisiones exponenciales si no se recibe ACK.

\begin{verbatim}
Cliente                                Servidor
  |                                        |
  |  CON [0x7d34] GET /temp               |
  +--------------------------------------->|
  |                                        |
  |  ACK [0x7d34] 2.05 Content "23.5°C"   |
  |<---------------------------------------+
  |                                        |
\end{verbatim}

\textbf{2. Non-Confirmable (NON):} Fire-and-forget, sin ACK ni retransmisiones.

\begin{verbatim}
Sensor                                 Gateway
  |                                        |
  |  NON [0x8a21] POST /telemetry          |
  +--------------------------------------->|
  |                                        |
  (sin ACK)
\end{verbatim}

\textbf{Selección de Modo:}
\begin{itemize}
\item \textbf{CON}: Comandos críticos (activar alarma, corte de servicio), firmware OTA, confirmación de escritura.
\item \textbf{NON}: Telemetría periódica (temperatura cada 30s), métricas no críticas, escenarios de alta frecuencia donde pérdida ocasional es aceptable.
\end{itemize}

\subsubsection{Observe - Subscripciones CoAP}

RFC 7641 define extensión Observe para subscripciones a recursos, eliminando necesidad de polling:

\begin{verbatim}
Cliente                                Servidor
  |                                        |
  |  CON [0x1234] GET /temp                |
  |  Observe: 0 (register)                 |
  +--------------------------------------->|
  |                                        |
  |  ACK [0x1234] 2.05 Content "22°C"     |
  |  Observe: 10 (sequence number)         |
  |<---------------------------------------+
  |                                        |
  ... (servidor detecta cambio de temperatura)
  |                                        |
  |  CON [0x5678] 2.05 Content "25°C"     |
  |  Observe: 11                           |
  |<---------------------------------------+
  |                                        |
  |  ACK [0x5678]                          |
  +--------------------------------------->|
\end{verbatim}

\textbf{Ventajas de Observe vs Polling HTTP:}
\begin{itemize}
\item Reduce tráfico en 90-95\% (notificaciones solo cuando hay cambios vs polling continuo cada N segundos).
\item Latencia de notificación <50 ms (vs 0.5×polling\_interval promedio para HTTP).
\item Menor consumo energético en dispositivos (no requiere wake-up periódico para polling).
\end{itemize}

\subsection{LwM2M - Gestión Ligera de Máquina a Máquina}

LwM2M (Lightweight Machine-to-Machine) es un protocolo de gestión de dispositivos IoT estandarizado por OMA SpecWorks (anteriormente Open Mobile Alliance), diseñado específicamente para dispositivos constrained~\cite{haEnablingDynamicLightweight2018,shahinzadehSmartHomeConnectivity2024}. LwM2M 1.2 (2019) es la versión actual con mejoras en seguridad y eficiencia.

\subsubsection{Arquitectura LwM2M}

\textbf{Componentes:}
\begin{itemize}
\item \textbf{LwM2M Client}: Ejecuta en dispositivo IoT (ej. medidor inteligente, sensor). Implementa objetos LwM2M y responde a operaciones del servidor~\cite{grafManagement6TiSCHNetworks2025}.
\item \textbf{LwM2M Server}: Gestiona flota de dispositivos. Ejecuta operaciones CRUD (Create, Read, Update, Delete) sobre objetos del cliente.
\item \textbf{Bootstrap Server (opcional)}: Provisiona credenciales y configuración inicial de clientes antes de conectar a LwM2M Server.
\end{itemize}

\textbf{Modelo de Objetos:}

LwM2M estructura datos en jerarquía de 3 niveles:
\begin{enumerate}
\item \textbf{Object}: Tipo de funcionalidad (ej. Object 3 = Device Info, Object 4 = Connectivity Monitoring).
\item \textbf{Object Instance}: Instancia específica de un objeto (ej. múltiples sensores de temperatura = múltiples instancias de Object 3303).
\item \textbf{Resource}: Dato individual dentro de instancia (ej. temperatura actual, timestamp, unidades).
\end{enumerate}

\textbf{Notación:}
\begin{verbatim}
/ObjectID/InstanceID/ResourceID
Ejemplo: /3303/0/5700 = Temperature Sensor (3303) / Instance 0 / Sensor Value (5700)
\end{verbatim}

\subsubsection{Objetos LwM2M Estándar para Smart Energy}

\begin{table}[h]
\centering
\small
\caption{Objetos LwM2M relevantes para Smart Energy IoT}
\label{tab:lwm2m-objects}
\begin{tabular}{|p{1.5cm}|p{3.5cm}|p{7cm}|}
\hline
\rowcolor{gray!20}
\textbf{Object ID} & \textbf{Nombre} & \textbf{Recursos Clave} \\
\hline
\textcolor{blue}{0} & \textcolor{blue}{Security} & Server URI (0), Bootstrap (1), Security Mode (2), Public Key (3), Secret Key (5) \\
\hline
\textcolor{blue}{1} & \textcolor{blue}{Server} & Lifetime (1), Min Period (2), Max Period (3), Disable (4), Notification Storing (6) \\
\hline
3 & Device & Manufacturer (0), Model (1), Serial Number (2), Firmware Ver (3), Reboot (4), Battery Level (9) \\
\hline
4 & Connectivity Monitoring & Network Bearer (0), Radio Signal Strength (2), Link Quality (3), IP Addresses (4) \\
\hline
5 & Firmware Update & Package (0), Package URI (1), Update (2), State (3), Update Result (5) \\
\hline
\textcolor{green}{3303} & \textcolor{green}{Temperature} & Sensor Value (5700), Units (5701), Min/Max (5601/5602) \\
\hline
\textcolor{green}{3305} & \textcolor{green}{Power Measurement} & Instantaneous Active Power (5800), Active Energy (5805), Reactive Energy (5810) \\
\hline
\textcolor{green}{3331} & \textcolor{green}{Voltage Measurement} & Sensor Value (5700), Min/Max (5601/5602), Application Type (5750) \\
\hline
\end{tabular}
\end{table}

\subsubsection{Operaciones LwM2M}

LwM2M define 8 operaciones que el servidor puede ejecutar sobre clientes:

\begin{enumerate}
\item \textbf{Read}: Leer valor de recurso/instancia/objeto (ej. leer temperatura actual \texttt{/3303/0/5700}).
\item \textbf{Write}: Escribir valor de recurso (ej. actualizar intervalo de reporte \texttt{/1/0/2}).
\item \textbf{Execute}: Ejecutar acción (ej. reiniciar dispositivo \texttt{/3/0/4}).
\item \textbf{Create}: Crear nueva instancia de objeto (ej. añadir segundo sensor temperatura).
\item \textbf{Delete}: Eliminar instancia de objeto.
\item \textbf{Observe}: Subscribirse a notificaciones de cambios en recurso (similar a CoAP Observe).
\item \textbf{Discover}: Obtener lista de objetos/recursos soportados por cliente.
\item \textbf{Write-Attributes}: Configurar atributos de notificación (pmin, pmax, gt, lt para thresholds).
\end{enumerate}

\textbf{Ejemplo de flujo Read-Write-Execute:}

\begin{verbatim}
Server                                    Client (Medidor)
  |                                            |
  | CoAP GET coap://client/3/0/3              | (Read firmware version)
  +-------------------------------------------->|
  |                                            |
  | 2.05 Content "v2.1.3"                      |
  |<--------------------------------------------+
  |                                            |
  | CoAP PUT coap://client/1/0/1              | (Write Lifetime = 3600s)
  | Payload: 3600                              |
  +-------------------------------------------->|
  |                                            |
  | 2.04 Changed                               |
  |<--------------------------------------------+
  |                                            |
  | CoAP POST coap://client/3/0/4             | (Execute Reboot)
  +-------------------------------------------->|
  |                                            |
  | 2.04 Changed                               |
  |<--------------------------------------------+
  |                                            |
  (dispositivo reinicia...)
\end{verbatim}

\subsubsection{Observe y Notificaciones}

LwM2M utiliza CoAP Observe (RFC 7641) para subscripciones eficientes con atributos de notificación avanzados:

\textbf{Atributos de Notificación:}
\begin{itemize}
\item \textbf{pmin (period min)}: Intervalo mínimo entre notificaciones (ej. 60s). Evita flooding si valor cambia rápidamente.
\item \textbf{pmax (period max)}: Intervalo máximo sin notificación (ej. 600s). Garantiza heartbeat incluso si valor no cambia.
\item \textbf{gt (greater than)}: Umbral superior. Notifica solo si valor > gt.
\item \textbf{lt (less than)}: Umbral inferior. Notifica solo si valor < lt.
\item \textbf{st (step)}: Cambio mínimo para notificación. Notifica solo si |valor\_nuevo - valor\_anterior| ≥ st.
\end{itemize}

\textbf{Ejemplo de configuración:}

\begin{verbatim}
Server                                    Client
  |                                            |
  | CoAP GET coap://client/3303/0/5700        | (Observe temperature)
  | Observe: 0                                 |
  | URI-Query: pmin=60&pmax=3600&gt=30        | (notificar si T>30°C, min 60s, max 1h)
  +-------------------------------------------->|
  |                                            |
  | 2.05 Content "22°C"                        |
  | Observe: 1                                 |
  |<--------------------------------------------+
  |                                            |
  ... (temperatura sube a 32°C después de 80s)
  |                                            |
  | CON [MID] 2.05 Content "32°C"             | (notificación porque T>30°C y pmin cumplido)
  | Observe: 2                                 |
  |<--------------------------------------------+
  |                                            |
  | ACK [MID]                                  |
  +-------------------------------------------->|
\end{verbatim}

Esta configuración reduce tráfico en >80\% vs polling periódico cada 60s, notificando solo cuando condiciones de umbral se cumplen.

\subsubsection{Firmware Update OTA con LwM2M}

Object 5 (Firmware Update) estandariza proceso de actualización remota:

\textbf{Flujo típico:}
\begin{enumerate}
\item Server escribe URI de firmware en \texttt{/5/0/1} (Package URI).
\item Server ejecuta \texttt{/5/0/2} (Update). Cliente descarga firmware en background.
\item Cliente reporta progreso en \texttt{/5/0/3} (State): 0=Idle, 1=Downloading, 2=Downloaded, 3=Updating.
\item Al completar descarga, cliente verifica firma digital y actualiza si válida.
\item Cliente reporta resultado en \texttt{/5/0/5} (Update Result): 0=Success, 1=Not enough storage, 2=Out of memory, etc.
\item Cliente reinicia con nuevo firmware.
\end{enumerate}

\textbf{Ventajas sobre soluciones propietarias:}
\begin{itemize}
\item Estandarizado (interoperable multi-vendor).
\item Reporta progreso granular (evita timeouts en descargas lentas).
\item Soporta download resume (crítico en enlaces inestables).
\item Integra verificación de integridad (checksum/firma digital).
\end{itemize}

\subsubsection{Bindings de Transporte}

LwM2M soporta múltiples bindings según capacidades de red:

\begin{table}[h]
\small
\centering
\caption{Bindings de Transporte LwM2M para Smart Energy IoT}
\label{tab:lwm2m-bindings}
\begin{tabular}{p{1.5cm}p{3.5cm}p{3.8cm}p{3cm}}
\hline
\rowcolor{gray!20}
\textbf{Binding} & \textbf{Transporte} & \textbf{Seguridad} & \textbf{Uso Smart Energy} \\
\hline
\textcolor{blue}{U} & \textcolor{blue}{UDP + CoAP} & DTLS + PSK/Certs & \textcolor{green}{Thread, HaLow, WiFi} \\
\hline
T & TCP + CoAP & TLS + PSK/Certs & LTE Cat-M1, NB-IoT \\
\hline
S & SMS & SMS encryption & Fallback NB-IoT \\
\hline
N & Non-IP (NB-IoT) & AS-layer security & NB-IoT optimizado \\
\hline
Q & MQTT & TLS + MQTT auth & Brokers existentes \\
\hline
\end{tabular}
\end{table}

\textbf{Selección de Binding:}
\begin{itemize}
\item \textbf{Binding U (UDP)}: Preferido para Thread/HaLow por overhead mínimo y soporte de multicast.
\item \textbf{Binding T (TCP)}: Para LTE Cat-M1 donde NAT traversal y session continuity son críticos.
\item \textbf{Binding Q (MQTT)}: Para integración con infraestructuras MQTT existentes (ej. ThingsBoard).
\end{itemize}

\subsubsection{Seguridad LwM2M}

\textbf{Modos de Seguridad (Security Object /0):}
\begin{enumerate}
\item \textbf{Pre-Shared Key (PSK)}: Clave simétrica 128-256 bits preconfigurada. Overhead mínimo (DTLS-PSK ~16 bytes).
\item \textbf{Raw Public Key (RPK)}: Claves públicas ECC sin certificados X.509 completos. Reduce overhead vs PKI.
\item \textbf{Certificate (X.509)}: PKI completa con certificados. Mayor overhead (~2 KB) pero mejor para deployments grandes.
\item \textbf{NoSec}: Sin seguridad (solo para testing, no producción).
\end{enumerate}

\textbf{Comparación de Overhead:}

\begin{table}[h]
\centering
\caption{Overhead de Seguridad LwM2M para Smart Energy IoT}
\label{tab:lwm2m-security-overhead}
\begin{tabular}{p{2cm}p{2.8cm}p{3.2cm}p{3.5cm}}
\hline
\rowcolor{gray!20}
\textbf{Modo} & \textbf{Handshake Size} & \textbf{Per-Message Overhead} & \textbf{Recomendación Smart Energy} \\
\hline
NoSec & 0 bytes & 0 bytes & \textcolor{red}{Solo testing} \\
\hline
\textcolor{blue}{PSK} & \textcolor{green}{~200 bytes} & \textcolor{green}{13-29 bytes (DTLS)} & \textcolor{blue}{Smart Energy recomendado} \\
\hline
RPK & ~500 bytes & 13-29 bytes (DTLS) & Deployments medianos \\
\hline
X.509 & \textcolor{red}{~3-5 KB} & 13-29 bytes (DTLS) & Enterprise, multi-tenant \\
\hline
\end{tabular}
\end{table}

Para Smart Energy con PSK preconfigurado, overhead de DTLS-PSK es ~15 bytes por mensaje vs ~40+ bytes TLS/TCP, reduciendo tráfico en 60\%.

\subsubsection{LwM2M vs Soluciones Propietarias}

\begin{table}[H]
\centering
\caption{Comparación LwM2M vs protocolos alternativos para gestión dispositivos Smart Energy}
\label{tab:lwm2m-comparison}
\resizebox{\textwidth}{!}{%
\begin{tabular}{|>{\centering\arraybackslash}p{2.8cm}|>{\centering\arraybackslash}p{3.2cm}|>{\centering\arraybackslash}p{3.2cm}|>{\centering\arraybackslash}p{2.8cm}|>{\centering\arraybackslash}p{2.8cm}|}
\hline
\rowcolor{blue!20}
\textbf{Característica} & \textbf{LwM2M 1.2} & \textbf{MQTT + JSON} & \textbf{HTTP REST} & \textbf{TR-069 CWMP} \\
\hline
\textbf{Overhead típico} & \textcolor{green}{\textbf{20-40 bytes}} & \textcolor{orange}{100-300 bytes} & \textcolor{red}{200-500 bytes} & \textcolor{red}{500-1500 bytes} \\
\hline
\textbf{Gestión dispositivos} & \textcolor{green}{\textbf{Nativa}} (objects std) & \textcolor{orange}{Custom} (topics) & \textcolor{orange}{Custom} (endpoints) & \textcolor{blue}{CPE WAN} (telco) \\
\hline
\textbf{Firmware OTA} & \textcolor{green}{\textbf{Estandarizado}} (Obj 5) & \textcolor{orange}{Custom impl} & \textcolor{orange}{Custom impl} & \textcolor{blue}{Download + Install} \\
\hline
\textbf{Observe/Subscribe} & \textcolor{green}{\textbf{Nativo + thresholds}} & \textcolor{blue}{MQTT native} & \textcolor{orange}{Polling o SSE} & \textcolor{orange}{Notification} \\
\hline
\textbf{Seguridad} & \textcolor{green}{\textbf{DTLS-PSK}} (ligero) & \textcolor{orange}{TLS} (pesado) & \textcolor{orange}{TLS} (pesado) & \textcolor{red}{SOAP/TLS} (muy pesado) \\
\hline
\textbf{Transporte} & \textcolor{green}{\textbf{UDP/SMS/TCP}} & \textcolor{blue}{TCP/WebSocket} & \textcolor{orange}{TCP only} & \textcolor{orange}{HTTP/SOAP} \\
\hline
\textbf{Interoperabilidad} & \textcolor{green}{\textbf{Multi-vendor}} (OMA) & \textcolor{red}{Propietario} & \textcolor{red}{Propietario} & \textcolor{blue}{Broadband Forum} \\
\hline
\textbf{Complejidad impl} & \textcolor{blue}{Media} & \textcolor{green}{\textbf{Baja}} & \textcolor{green}{\textbf{Baja}} & \textcolor{red}{Alta} \\
\hline
\textbf{Casos de uso Smart Energy} & \textcolor{green}{\textbf{Medidores IoT}} & \textcolor{blue}{Telemetría} & \textcolor{orange}{APIs web} & \textcolor{orange}{CPE/modems} \\
\hline
\textbf{Eficiencia energética} & \textcolor{green}{\textbf{Excelente}} (PSM) & \textcolor{blue}{Buena} (keepalive) & \textcolor{orange}{Regular} (polling) & \textcolor{red}{Pobre} (XML) \\
\hline
\textbf{Aplicabilidad tesis} & \textcolor{green}{\textbf{Alta}} - Protocolo principal & \textcolor{blue}{Media} - Gateway-cloud & \textcolor{orange}{Baja} - APIs legacy & \textcolor{red}{Nula} \\
\hline
\end{tabular}%
}
\end{table}

\textbf{Ventajas de LwM2M para Smart Energy:}
\begin{itemize}
\item Reduce tráfico de gestión en 70-80\% vs MQTT/JSON (objetos binarios TLV vs JSON verbose).
\item Estandariza operaciones comunes (device info, connectivity monitoring, firmware update) eliminando necesidad de reinventar.
\item Soporta notificaciones con thresholds complejos (pmin/pmax/gt/lt/st) reduciendo tráfico adicional 80-90\%.
\item DTLS-PSK con overhead 60\% menor que TLS/TCP, crítico para dispositivos battery-powered.
\end{itemize}

\subsection{Wi-Fi HaLow (IEEE 802.11ah) - Última Milla de Largo Alcance}

IEEE 802.11ah, comercialmente denominado Wi-Fi HaLow, es un estándar ratificado en 2017 que extiende Wi-Fi a bandas sub-GHz (sub-1 GHz), optimizado para aplicaciones IoT de largo alcance con miles de dispositivos concurrentes~\cite{scharerPushingWiFiHaLow2025,ahmedMACProtocolsIEEE2022}.

\subsubsection{Características Técnicas Distintivas}

\begin{itemize}
\item \textbf{Frecuencia}: Bandas regionales no licenciadas: 902-928 MHz (EE.UU./América), 863-868 MHz (Europa), 755-787 MHz (China, Korea), 917-923.5 MHz (Japón)~\cite{qiaoSurveyWiFiHaLow2018}.

\item \textbf{Channel width}: 1, 2, 4, 8, 16 MHz (downclocking de 802.11ac por factor 10×).

\item \textbf{Modulación}: MCS 0-10 (BPSK, QPSK, 16-QAM, 64-QAM, 256-QAM opcional), con LDPC o BCC FEC~\cite{leeWiFiHaLowLongRange2021}.

\item \textbf{Alcance}: 1-2 km en exteriores (LOS - Line of Sight), 100-300 m en interiores con penetración superior a 2.4/5 GHz gracias a propagación sub-GHz~\cite{khanWiFiHalowSignal2020}.

\item \textbf{Throughput}: 150 kbps (MCS 0, 1 MHz BW) hasta 86.7 Mbps (MCS 10, 16 MHz BW, 4 spatial streams - teórico)~\cite{enrikoWiFiHaLowLiterature2024}.

\item \textbf{Número de estaciones}: Hasta 8,191 dispositivos por AP mediante hierarchical AID (Association Identifier) con páginas~\cite{ahmedSoftFarmNetReconfigurableWiFi2023}.

\item \textbf{Power save}: Target Wake Time (TWT) permite negociar ventanas de actividad, logrando duty cycles <1\% con años de autonomía en batería~\cite{surendrarajuWiFiHaLowInternet2023}.
\end{itemize}

\subsubsection{Análisis de Capa Física HaLow}

HaLow reutiliza la capa física OFDM de 802.11ac/n, reduciendo bandwidth y clock rate por factor 10 para operar en sub-GHz~\cite{kimIEEE80211ahHaLow2021}. Los parámetros clave son:

\begin{equation}
T_{symbol} = 40 \,\mu s \quad (\text{vs } 4 \,\mu s \text{ en 802.11ac})
\end{equation}

\begin{equation}
N_{subcarriers} = \begin{cases}
32 & (1 \text{ MHz BW}) \\
64 & (2 \text{ MHz BW}) \\
128 & (4 \text{ MHz BW}) \\
256 & (8 \text{ MHz BW}) \\
512 & (16 \text{ MHz BW})
\end{cases}
\end{equation}

El data rate se calcula como:

\begin{equation}
R_{data} = \frac{N_{DBPS} \times N_{SS} \times R_{code}}{T_{symbol} + T_{GI}}
\end{equation}

donde:
\begin{itemize}
\item $N_{DBPS}$: Data bits per symbol (depende de modulación y BW)
\item $N_{SS}$: Number of spatial streams (1-4)
\item $R_{code}$: Code rate (1/2, 2/3, 3/4, 5/6)
\item $T_{GI}$: Guard interval (8 o 4 µs)
\end{itemize}

Tabla completa de MCS para 1 MHz channel width (caso típico Smart Energy):

\begin{table}[H]
\centering
\small
\caption{MCS HaLow para 1 MHz channel width - Aplicaciones Smart Energy IoT}
\label{tab:halow-mcs}
\resizebox{\textwidth}{!}{%
\begin{tabular}{|>{\centering\arraybackslash}p{1.2cm}|>{\centering\arraybackslash}p{2cm}|>{\centering\arraybackslash}p{1.6cm}|>{\centering\arraybackslash}p{2.2cm}|>{\centering\arraybackslash}p{2.4cm}|>{\centering\arraybackslash}p{3.2cm}|}
\hline
\rowcolor{blue!20}
\textbf{MCS} & \textbf{Modulación} & \textbf{Code Rate} & \textbf{Data Rate (Mbps)} & \textbf{Sensitivity (dBm)} & \textbf{Aplicación Smart Energy} \\
\hline
\textcolor{green}{\textbf{0}} & BPSK & 1/2 & \textcolor{green}{\textbf{0.150}} & \textcolor{blue}{\textbf{-99}} & \textbf{Sensores remotos}, largo alcance \\
\hline
\textcolor{green}{\textbf{1}} & QPSK & 1/2 & \textcolor{green}{\textbf{0.300}} & \textcolor{blue}{\textbf{-96}} & Medidores inteligentes \\
\hline
\textcolor{green}{\textbf{2}} & QPSK & 3/4 & \textcolor{green}{\textbf{0.450}} & \textcolor{blue}{\textbf{-94}} & Telemetría básica \\
\hline
\textcolor{blue}{\textbf{3}} & 16-QAM & 1/2 & \textcolor{blue}{\textbf{0.600}} & \textcolor{blue}{-91} & \textbf{Recomendado tesis} \\
\hline
\textcolor{blue}{\textbf{4}} & 16-QAM & 3/4 & \textcolor{blue}{\textbf{0.900}} & -88 & Gateway to cloud \\
\hline
\textbf{5} & 64-QAM & 2/3 & \textbf{1.200} & -85 & Datos de respaldo \\
\hline
\textbf{6} & 64-QAM & 3/4 & \textbf{1.350} & -82 & Video/imágenes \\
\hline
\textbf{7} & 64-QAM & 5/6 & \textbf{1.500} & -80 & Aplicaciones multimedia \\
\hline
\textcolor{orange}{8} & 256-QAM & 3/4 & \textcolor{orange}{1.800} & \textcolor{red}{-77} & Corto alcance únicamente \\
\hline
\textcolor{orange}{9} & 256-QAM & 5/6 & \textcolor{orange}{2.000} & \textcolor{red}{-75} & Laboratorio/urban \\
\hline
\textcolor{gray}{10} & \textcolor{gray}{—} & \textcolor{gray}{—} & \textcolor{gray}{(Reservado)} & \textcolor{gray}{—} & \textcolor{gray}{Futuro} \\
\hline
\end{tabular}%
}
\end{table}

El link budget de HaLow permite alcances superiores a tecnologías 2.4 GHz:

\begin{equation}
\text{Path Loss} = 20 \log_{10}(f) + 20 \log_{10}(d) + 32.44
\end{equation}

Para 900 MHz vs 2400 MHz a distancia $d=1$ km:

\begin{align}
PL_{900MHz} &= 20 \log_{10}(900) + 20 \log_{10}(1000) + 32.44 = 91.5 \text{ dB} \\
PL_{2400MHz} &= 20 \log_{10}(2400) + 20 \log_{10}(1000) + 32.44 = 100.0 \text{ dB}
\end{align}

Ganancia de propagación: $100.0 - 91.5 = 8.5$ dB, equivalente a $\approx 2.4\times$ de alcance para misma potencia TX.

\subsubsection{Modos de Operación HaLow}

\textbf{1. Target Wake Time (TWT):} Mecanismo de ahorro de energía que permite al AP negociar con cada estación ventanas de actividad específicas. Parámetros TWT:

\begin{itemize}
\item \textbf{TWT Wake Interval}: Período entre ventanas de actividad (ej. 60 segundos).
\item \textbf{TWT Wake Duration}: Duración de ventana activa (ej. 10 ms).
\item \textbf{TWT Flow ID}: Identificador de flujo para múltiples acuerdos TWT simultáneos.
\end{itemize}

Duty cycle logrado:
\begin{equation}
DC = \frac{T_{wake}}{T_{interval}} = \frac{10 \text{ ms}}{60 \text{ s}} = 0.017\% \rightarrow \text{autonomía de años con batería AA}
\end{equation}

\textbf{2. Restricted Access Window (RAW):} Mecanismo para coordinar acceso de múltiples estaciones, dividiendo tiempo en slots asignados a grupos de dispositivos (RAW groups) para reducir colisiones en redes densas.

\textbf{3. Sectorization:} Capacidad del AP de utilizar antenas direccionales o phased arrays para crear sectores espaciales, aumentando capacidad y mitigando interferencia.

\subsubsection{Análisis Comparativo de Bandwidths 2/4/8 MHz para Smart Energy}

La selección estratégica de bandwidth HaLow es crítica para optimizar el trade-off entre alcance, throughput, latencia y eficiencia espectral según caso de uso específico. Los bandwidths 2/4/8 MHz representan el rango práctico para aplicaciones Smart Energy (1 MHz demasiado lento para backhaul, 16 MHz excesivo para alcance requerido).

\textbf{2 MHz Bandwidth - Conexiones Estables de Largo Alcance}

\textbf{Características Técnicas:}
\begin{itemize}
\item \textbf{MCS típico}: MCS 1-2 (QPSK, code rate 1/2 - 3/4)
\item \textbf{Throughput}: 300-450 kbps por enlace, 6-8 Mbps agregado con 20 clientes
\item \textbf{Sensibilidad}: -96 dBm @ MCS 1 (QPSK 1/2), -94 dBm @ MCS 2 (QPSK 3/4)
\item \textbf{Alcance}: >2 km en exteriores NLOS, >3 km LOS con antena direccional 10 dBi
\item \textbf{Latencia}: 80-120 ms típica (incluye contención CSMA/CA + retransmisiones)
\item \textbf{Robustez}: PDR >98\% con SNR 8-12 dB (condiciones adversas multipath/interferencia)
\end{itemize}

\textbf{Link Budget @ 2 MHz:}
\begin{align}
P_{TX} &= 20 \text{ dBm (100 mW)} \\
G_{TX} &= 5 \text{ dBi (antena omnidireccional AP)} \\
G_{RX} &= 2 \text{ dBi (antena cliente)} \\
Sensitivity_{MCS1} &= -96 \text{ dBm} \\
\text{Path Loss permitido} &= 20 + 5 + 2 - (-96) = 123 \text{ dB}
\end{align}

Con modelo de propagación Hata urbano (900 MHz):
\begin{equation}
PL = 69.55 + 26.16 \log_{10}(f) - 13.82 \log_{10}(h_b) + (44.9 - 6.55 \log_{10}(h_b)) \log_{10}(d)
\end{equation}

Para $h_b=15$ m (altura AP), $f=915$ MHz:
\begin{equation}
123 = 124.7 + 33.3 \log_{10}(d) \rightarrow d \approx 2.2 \text{ km (NLOS urbano)}
\end{equation}

\textbf{Casos de Uso 2 MHz:}
\begin{enumerate}
\item \textbf{Sensores remotos rurales}: Medidores en zonas periféricas a >1.5 km del gateway, sin línea de vista directa, con edificaciones/vegetación intermedia.
\item \textbf{Penetración indoor profunda}: Medidores en sótanos o instalaciones eléctricas subterráneas donde pérdida adicional indoor es 15-25 dB.
\item \textbf{Telemetría baja frecuencia}: Lecturas horarias o diarias donde throughput <500 kbps es suficiente (ej. 100 medidores × 200 bytes × 4 lecturas/hora = 22 kbps promedio).
\item \textbf{Redundancia/failover}: Enlaces secundarios de respaldo para gateways con uplink primario de 4-8 MHz, activándose solo cuando primario falla.
\end{enumerate}

\textbf{4 MHz Bandwidth - Balance Gestión y Throughput}

\textbf{Características Técnicas:}
\begin{itemize}
\item \textbf{MCS típico}: MCS 3-4 (16-QAM, code rate 1/2 - 3/4)
\item \textbf{Throughput}: 600-900 kbps por enlace, 40-60 Mbps agregado con 50+ clientes
\item \textbf{Sensibilidad}: -91 dBm @ MCS 3 (16-QAM 1/2), -88 dBm @ MCS 4 (16-QAM 3/4)
\item \textbf{Alcance}: 1-1.5 km exteriores, 300-500 m indoor
\item \textbf{Latencia}: 40-60 ms P95 (menor contención que 2 MHz debido a mayor throughput)
\item \textbf{Eficiencia espectral}: 0.15-0.225 bps/Hz (vs 0.15-0.225 bps/Hz en 2 MHz - similar pero con 2× bandwidth absoluto)
\end{itemize}

\textbf{Link Budget @ 4 MHz:}
\begin{align}
\text{Path Loss permitido} &= 20 + 5 + 2 - (-91) = 118 \text{ dB} \\
\rightarrow d &\approx 1.4 \text{ km (NLOS urbano, 5 dB menos que 2 MHz)}
\end{align}

\textbf{Ventajas de 4 MHz:}
\begin{itemize}
\item \textbf{Throughput 2× superior}: Permite agregación de más dispositivos por gateway (50+ vs 20 en 2 MHz) sin saturar enlace.
\item \textbf{Latencia reducida}: Mayor throughput reduce tiempo de transmisión de paquetes grandes (ej. 1000 bytes @ 900 kbps = 9 ms vs 18 ms @ 450 kbps).
\item \textbf{Soporta firmware OTA}: Transferencia de imágenes de 200-500 KB en tiempos razonables (5-10 min) para actualizaciones masivas simultáneas.
\item \textbf{Balance alcance/capacidad}: Cubre zona suburbana típica (1-1.5 km) manteniendo capacidad para densidad media de dispositivos.
\end{itemize}

\textbf{Casos de Uso 4 MHz:}
\begin{enumerate}
\item \textbf{Gestión balanceada zonas suburbanas}: 30-50 medidores con lecturas cada 15 min (96 lecturas/día × 50 medidores = 4,800 transacciones/día, tráfico promedio ~15 kbps).
\item \textbf{Backhaul de concentradores Thread}: DCUs que agregan datos de 50-100 nodos Thread (total 5-10 Mbps uplink hacia gateway).
\item \textbf{Aplicaciones bidireccionales}: Comandos downlink frecuentes (respuesta a demanda, control de carga) requiriendo latencia <100 ms.
\item \textbf{Arquitectura de referencia Smart Energy}: Zona de 300-500 medidores × 3-5 DCUs intermedios × 1 gateway central (throughput agregado 20-30 Mbps).
\end{enumerate}

\textbf{8 MHz Bandwidth - Alto Tráfico con Línea de Vista}

\textbf{Características Técnicas:}
\begin{itemize}
\item \textbf{MCS típico}: MCS 5-7 (64-QAM, code rate 2/3 - 5/6)
\item \textbf{Throughput}: 1.2-1.8 Mbps por enlace, >80 Mbps agregado con 50+ clientes
\item \textbf{Sensibilidad}: -85 dBm @ MCS 5 (64-QAM 2/3), -80 dBm @ MCS 7 (64-QAM 5/6)
\item \textbf{Alcance}: 0.5-1 km LOS exteriores, <200 m NLOS (degradación significativa)
\item \textbf{Latencia}: <20 ms P99 (mínima contención, procesamiento rápido)
\item \textbf{Eficiencia espectral}: 0.15-0.225 bps/Hz (similar a 2/4 MHz - ley Shannon limits)
\end{itemize}

\textbf{Link Budget @ 8 MHz:}
\begin{align}
\text{Path Loss permitido} &= 20 + 5 + 2 - (-85) = 112 \text{ dB} \\
\rightarrow d &\approx 0.9 \text{ km (NLOS urbano, 11 dB menos que 2 MHz)} \\
\rightarrow d_{LOS} &\approx 1.5\text{-}2 \text{ km (LOS con Fresnel zone clearance)}
\end{align}

\textbf{Ventajas de 8 MHz:}
\begin{itemize}
\item \textbf{Throughput máximo}: 4× superior a 2 MHz, permite backhaul de múltiples concentradores simultáneos (ej. 5 DCUs × 10 Mbps = 50 Mbps agregado).
\item \textbf{Latencia ultra-baja}: Crítico para aplicaciones tiempo-real (respuesta a demanda <50 ms, detección de fallas <100 ms).
\item \textbf{Firmware OTA masivo}: Actualización simultánea de 50+ dispositivos con imágenes 500 KB en <5 minutos (vs 20-30 min con 2-4 MHz).
\item \textbf{Soporta video/analytics}: Streaming de cámaras de inspección, telemetría de alta frecuencia (muestreo 1 kHz para calidad de potencia).
\end{itemize}

\textbf{Limitaciones de 8 MHz:}
\begin{itemize}
\item \textbf{Requiere LOS o quasi-LOS}: Degradación rápida con obstrucciones (cada 6 dB adicional de pérdida reduce throughput 50\%).
\item \textbf{Sensible a interferencia}: Mayor bandwidth = mayor probabilidad de interferencia cocanal en espectro ISM 902-928 MHz.
\item \textbf{Menor alcance}: 40-50\% de alcance de 2 MHz en mismas condiciones.
\end{itemize}

\textbf{Casos de Uso 8 MHz:}
\begin{enumerate}
\item \textbf{Backhaul urbano LOS}: Enlaces punto-a-punto entre gateways en edificios con línea de vista (ej. edificio A torre 15m → edificio B torre 12m, distancia 800m).
\item \textbf{Agregación de concentradores}: Gateway central agregando datos de 5-10 DCUs intermedios (cada DCU gestiona 50-100 medidores).
\item \textbf{Aplicaciones críticas tiempo-real}: Protección diferencial de líneas eléctricas, detección de fallas de arco, respuesta rápida a eventos de calidad de potencia.
\item \textbf{Zonas industriales/campus}: Infraestructura controlada con topología planificada (postes/torres optimizados para LOS).
\end{enumerate}

\textbf{Tabla Comparativa 2/4/8 MHz:}

\begin{table}[h]
\centering
\caption{Comparación de Bandwidths HaLow para Smart Energy}
\label{tab:halow-bw-comparison}
\begin{tabular}{|p{3.5cm}|p{3.5cm}|p{3.5cm}|p{3.5cm}|}
\hline
\textbf{Métrica} & \textbf{2 MHz} & \textbf{4 MHz} & \textbf{8 MHz} \\
\hline
\textbf{Throughput/enlace} & 300-450 kbps & 600-900 kbps & 1.2-1.8 Mbps \\
\hline
\textbf{Throughput agregado} & 6-8 Mbps (20 nodos) & 40-60 Mbps (50 nodos) & >80 Mbps (50+ nodos) \\
\hline
\textbf{Sensibilidad MCS típico} & -96 dBm & -91 dBm & -85 dBm \\
\hline
\textbf{Alcance NLOS} & >2 km & 1-1.5 km & 0.5-0.9 km \\
\hline
\textbf{Alcance LOS} & >3 km & 2-2.5 km & 1.5-2 km \\
\hline
\textbf{Latencia P95} & 80-120 ms & 40-60 ms & <20 ms \\
\hline
\textbf{PDR @ SNR 10dB} & 98-99\% & 96-98\% & 92-96\% \\
\hline
\textbf{Nodos soportados} & 20-30 & 50-80 & 80-150 \\
\hline
\textbf{Caso uso óptimo} & Remoto/rural NLOS & Suburbano balanceado & Urbano LOS backhaul \\
\hline
\textbf{Costo energético TX} & Bajo (100 mW avg) & Medio (150-200 mW) & Alto (250-350 mW) \\
\hline
\end{tabular}
\end{table}

\textbf{Estrategia de Selección de Bandwidth:}

\begin{enumerate}
\item \textbf{Análisis de propagación}: Realizar site survey con herramientas RF (Ekahau, Ubiquiti) midiendo RSSI/SNR en puntos críticos. Si RSSI promedio <-85 dBm → 2 MHz. Si RSSI -75 a -85 dBm → 4 MHz. Si RSSI >-75 dBm con LOS → 8 MHz.

\item \textbf{Estimación de tráfico}: Calcular throughput agregado requerido:
\begin{equation}
T_{required} = N_{devices} \times \frac{PayloadSize}{ReportInterval} \times (1 + \text{Overhead}_{protocol})
\end{equation}

Ejemplo: 50 medidores, 200 bytes, cada 15 min, overhead 40\%:
\begin{equation}
T_{req} = 50 \times \frac{200 \text{ bytes}}{900 \text{ s}} \times 1.4 = 15.5 \text{ kbps} \rightarrow \text{2 MHz suficiente}
\end{equation}

Si $T_{req} > 5$ Mbps → 4 MHz. Si $T_{req} > 30$ Mbps → 8 MHz.

\item \textbf{Requisitos de latencia}: Aplicaciones DR/protección requieren P95 <50 ms → 4-8 MHz. Telemetría batch tolerante a 100-200 ms → 2-4 MHz.

\item \textbf{Arquitectura multi-banda}: Desplegar APs dual-radio con 2 MHz (largo alcance) + 8 MHz (backhaul) en mismo gateway, band-steering dinámico según RSSI/carga.
\end{enumerate}

\textbf{Recomendación para Arquitectura Smart Energy (900 medidores):}
\begin{itemize}
\item \textbf{Tier 1 (sensores remotos)}: 2 MHz para 300 medidores periféricos (>1.5 km, NLOS)
\item \textbf{Tier 2 (gestión media)}: 4 MHz para 500 medidores zona suburbana (0.5-1.5 km)
\item \textbf{Tier 3 (backhaul concentradores)}: 8 MHz para 3-5 DCUs intermedios agregando datos (LOS, <1 km)
\end{itemize}

Esta estrategia multi-banda maximiza cobertura (tier 1), capacidad (tier 2) y latencia (tier 3) con inversión de infraestructura optimizada.

\subsection{LTE Cat-M1 / NB-IoT - Conectividad Celular IoT}

LTE Cat-M1 (eMTC) y NB-IoT (Narrowband IoT) son tecnologías celulares 3GPP Release 13/14 optimizadas para aplicaciones IoT, operando sobre infraestructura LTE existente con cobertura global y movilidad nativa.

\subsubsection{Comparativa Cat-M1 vs NB-IoT}

\begin{table}[H]
\centering
\caption{Comparación detallada LTE Cat-M1 vs NB-IoT para aplicaciones Smart Energy}
\label{tab:lte-iot-comparison}
\resizebox{\textwidth}{!}{%
\begin{tabular}{|>{\centering\arraybackslash}p{3.2cm}|>{\centering\arraybackslash}p{4.8cm}|>{\centering\arraybackslash}p{4.8cm}|}
\hline
\rowcolor{blue!20}
\textbf{Característica} & \textbf{LTE Cat-M1 (eMTC)} & \textbf{NB-IoT} \\
\hline
\textbf{Bandwidth asignado} & \textcolor{blue}{1.4 MHz} (6 PRBs) & \textcolor{orange}{200 kHz} (1 PRB o standalone) \\
\hline
\textbf{Peak rate DL/UL} & \textbf{1 Mbps} / 1 Mbps & 250 kbps / \textbf{250 kbps} (multi-tone) \\
\hline
\textbf{Latencia típica} & \textcolor{green}{10-15 ms} (connected mode) & \textcolor{red}{1.6-10 s} (idle-to-connected) \\
\hline
\textbf{Soporte movilidad} & \textcolor{green}{\textbf{Full mobility}} (handover) & \textcolor{orange}{Limited} (reselection only) \\
\hline
\textbf{Soporte voz} & \textcolor{green}{VoLTE} (half-duplex) & \textcolor{red}{No soportado} \\
\hline
\textbf{Consumo potencia} & PSM: \textbf{3 µA}, eDRX: 0.2 mA & PSM: 5 µA, eDRX: \textbf{0.6 mA} \\
\hline
\textbf{MCL (Max Coupling Loss)} & 156 dB & \textcolor{green}{\textbf{164 dB}} (+8 dB mejor) \\
\hline
\textbf{Modos despliegue} & \textcolor{orange}{In-band LTE} únicamente & \textcolor{green}{In-band / Guard-band / \textbf{Standalone}} \\
\hline
\textbf{Casos de uso Smart Energy} & \begin{minipage}[t]{4.8cm}
\vspace{1mm}
• Asset tracking DER \\
• Wearables técnicos \\
• \textbf{Smart meters} bidireccional \\
• Vehículos eléctricos
\vspace{1mm}
\end{minipage} & \begin{minipage}[t]{4.8cm}
\vspace{1mm}
• \textbf{Medidores inteligentes} \\
• Sensores ambientales \\
• Monitoreo infraestructura \\
• Reportes esporádicos
\vspace{1mm}
\end{minipage} \\
\hline
\textbf{Aplicabilidad tesis} & \textcolor{blue}{Media} (backup celular) & \textcolor{green}{\textbf{Alta}} (sensores remotos) \\
\hline
\end{tabular}%
}
\end{table}

Para aplicaciones Smart Energy donde se requiere throughput moderado (kB/s) y latencia <100 ms, LTE Cat-M1 es preferible. NB-IoT se optimiza para sensores ultra-low-power con reportes esporádicos (daily).

\subsubsection{Optimizaciones de Potencia LTE IoT}

\textbf{1. Power Saving Mode (PSM):} El dispositivo entra en deep sleep profundo donde solo el timer RTC permanece activo. No es accesible desde red (downlink imposible). Consumo típico: 3-5 µA. Timers T3324 (Active Timer) y T3412 (TAU periodic update).

\textbf{2. Extended Discontinuous Reception (eDRX):} Extiende ciclos DRX de segundos a minutos/horas. El dispositivo sincroniza con red solo en ventanas eDRX periódicas. Permite MT (mobile terminated) traffic a diferencia de PSM. Consumo: 0.2-0.6 mA promedio.

\textbf{3. Release Assistance Indication (RAI):} El dispositivo señaliza a la red que no espera más tráfico, acelerando liberación de conexión RRC.

\subsection{Capa de Enlace IEEE 802.15.4}

IEEE 802.15.4 define las capas física (PHY) y de control de acceso al medio (MAC) para redes de área personal inalámbricas de baja potencia (LR-WPAN). Esta especificación constituye la base sobre la cual operan protocolos de capa superior como Thread, Zigbee y 6LoWPAN.

\subsubsection{Características Principales de la Capa MAC}

La capa MAC de IEEE 802.15.4 proporciona servicios fundamentales para comunicación confiable en redes de sensores:

\textbf{Control de Acceso al Medio}: Implementa CSMA/CA (Carrier Sense Multiple Access with Collision Avoidance) para coordinar el acceso al canal compartido entre múltiples dispositivos. El mecanismo utiliza backoff exponencial para reducir colisiones: antes de transmitir, un nodo espera un tiempo aleatorio proporcional a $2^{BE}$ unidades de tiempo, donde el Backoff Exponent (BE) aumenta con cada intento fallido.

\textbf{Confirmación de Recepción}: Frames de datos pueden requerir acknowledgment (ACK) explícito del receptor. Si el ACK no se recibe dentro de un timeout (macAckWaitDuration), el transmisor reintenta la transmisión hasta un máximo de retransmisiones configurables (típicamente 3 intentos).

\textbf{Estructura de Frame}: Los frames MAC incluyen headers de 9-25 bytes (dependiendo de direccionamiento) que contienen: control de frame (2 bytes), número de secuencia (1 byte), direcciones PAN y dispositivo (2-8 bytes cada una), y Frame Check Sequence (FCS) de 2 bytes para detección de errores.

\textbf{Direccionamiento}: Soporta direccionamiento corto de 16 bits (para redes <65,536 nodos) y direccionamiento extendido IEEE EUI-64 de 64 bits para direccionamiento global único.

\textbf{Modos de Operación}: Define dispositivos Full Function Device (FFD) capaces de routing y coordinación, y Reduced Function Device (RFD) simples que solo comunican con un coordinador padre.

\subsubsection{Eficiencia y Limitaciones}

El MTU (Maximum Transmission Unit) de IEEE 802.15.4 es de 127 bytes, de los cuales aproximadamente 25 bytes se consumen en headers PHY/MAC y FCS, dejando ~102 bytes disponibles para payload de capas superiores. Esta restricción motiva el uso de mecanismos de compresión como 6LoWPAN IPHC, que reduce headers IPv6+UDP de 48 bytes a ~6 bytes.

En redes con alta densidad de nodos, el algoritmo CSMA/CA puede experimentar degradación de throughput debido a colisiones y retransmisiones. Thread mitiga esto mediante traffic shaping en capa de aplicación y jitter aleatorio para distribuir transmisiones temporalmente.

El análisis cuantitativo detallado de tiempos de backoff, probabilidades de colisión, y throughput en función del número de nodos se presenta en el Capítulo 3 como parte de la caracterización experimental de la implementación.

\section{Estándares de Interoperabilidad Smart Energy}

\subsection{IEEE 2030.5-2023 (Smart Energy Profile 2.0)}

IEEE 2030.5, anteriormente conocido como ZigBee SEP 2.0, es el estándar de facto para interoperabilidad de dispositivos Smart Energy en América del Norte (mandatorio para DR programs en California SB-2030)~\cite{IEEERecommendedPractice,knyazevComparativeAnalysisStandards2017}. Define un modelo RESTful sobre HTTP/TLS para comunicación cliente-servidor entre dispositivos de campo (medidores, termostatos, inversores solares) y sistemas de gestión (DERMS, head-end systems)~\cite{tangResearchInteroperabilityIoT}.

\subsubsection{Arquitectura RESTful del Estándar}

IEEE 2030.5 estructura funcionalidades en Function Sets, cada uno exponiendo recursos REST con URIs jerárquicas~\cite{sanemeteriodelaparteSISSSemanticInteroperability2025}:

\begin{itemize}
\item \textbf{/dcap} (Device Capability): Punto de entrada para descubrir Function Sets soportados.
\item \textbf{/tm} (Time): Sincronización horaria NTP-like.
\item \textbf{/edev} (End Device): Registro y gestión de dispositivos.
\item \textbf{/mup} (Mirror Usage Point): Espejo de datos de medición.
\item \textbf{/mr} (Meter Reading): Lecturas de perfiles de carga.
\item \textbf{/msg} (Messaging): Notificaciones y alertas bidireccionales.
\item \textbf{/dr} (Demand Response): Programación de eventos DR.
\item \textbf{/fsa} (Flow Reservation): QoS para flujos críticos.
\end{itemize}

Ejemplo de request GET al Function Set Time:

\begin{verbatim}
GET /tm HTTP/1.1
Host: gateway.smartenergy.local
Accept: application/sep+xml
\end{verbatim}

Response:
\begin{verbatim}
HTTP/1.1 200 OK
Content-Type: application/sep+xml

<Time xmlns="urn:ieee:std:2030.5:ns">
  <currentTime>1698796800</currentTime>
  <dstEndTime>1730617200</dstEndTime>
  <dstOffset>3600</dstOffset>
  <dstStartTime>1710054000</dstStartTime>
  <localTime>-18000</localTime>
  <quality>7</quality>
</Time>
\end{verbatim}

\subsubsection{Function Sets Implementados}

\textbf{1. Device Capability (DCAP)}: El cliente consulta /dcap para descubrir qué Function Sets implementa el servidor:

\begin{verbatim}
<DeviceCapability>
  <EndDeviceListLink href="/edev"/>
  <MirrorUsagePointListLink href="/mup"/>
  <TimeLink href="/tm"/>
  <MessagingProgramListLink href="/msg"/>
</DeviceCapability>
\end{verbatim}

\textbf{2. End Device (ED)}: Registro de dispositivos con LFDI (Long Form Device Identifier) derivado de certificado X.509:

\begin{equation}
\text{LFDI} = \text{SHA256}(\text{SubjectPublicKeyInfo})[:160 \text{ bits}]
\end{equation}

\textbf{3. Mirror Meter Reading (MMR)}: Publicación de lecturas de medición con granularidad configurable (típicamente 15 minutos). Datos codificados en formato OBIS (Object Identification System) según IEC 62056:

\begin{itemize}
\item 1-0:1.8.0*255 (Active energy import total)
\item 1-0:2.8.0*255 (Active energy export total)
\item 1-0:31.7.0*255 (Instantaneous current L1)
\end{itemize}

\textbf{4. Messaging (MSG)}: Push notifications del servidor hacia clientes mediante polling o subscriptions. Prioridades 0-9, donde 0 es crítico (ej. alerta de sobretensión).

\subsubsection{Modelo de Datos y Schemas XML}

IEEE 2030.5 define schemas XML estrictos para todos los recursos. Ejemplo completo de MirrorMeterReading:

\begin{verbatim}
<MirrorMeterReading xmlns="urn:ieee:std:2030.5:ns">
  <mRID>4A8F6B3C</mRID>
  <description>Smart Meter #12345</description>
  <Reading>
    <timePeriod>
      <duration>900</duration>
      <start>1698796800</start>
    </timePeriod>
    <value>12500</value>
    <ReadingType>
      <accumulationBehaviour>4</accumulationBehaviour>
      <commodity>1</commodity>
      <dataQualifier>12</dataQualifier>
      <flowDirection>1</flowDirection>
      <powerOfTenMultiplier>0</powerOfTenMultiplier>
      <uom>72</uom>
    </ReadingType>
  </Reading>
</MirrorMeterReading>
\end{verbatim}

Donde:
\begin{itemize}
\item \texttt{commodity=1}: Electricidad
\item \texttt{uom=72}: Wh (Watt-hour)
\item \texttt{flowDirection=1}: Forward (import)
\item \texttt{accumulationBehaviour=4}: Cumulative
\end{itemize}

El estándar define 200+ ReadingTypes combinando 7 dimensiones (commodity, uom, flowDirection, etc.) para representar cualquier tipo de medición energética.

\subsection{ISO/IEC 30141:2024 - IoT Reference Architecture}

ISO/IEC 30141, publicado en 2018 y actualizado en 2024, proporciona un marco arquitectónico normalizado para sistemas IoT, definiendo componentes, interfaces y flujos de información. Complementa a ISO/IEC 29100 (Privacy Framework) y ISO/IEC 27001 (Security Management).

\subsubsection{Modelo de Capas}

ISO/IEC 30141 define cuatro vistas complementarias:

\textbf{1. Vista Funcional:} Descompone el sistema IoT en entidades funcionales (FE - Functional Entities):

\begin{itemize}
\item \textbf{Sensing FE}: Adquisición de datos del mundo físico (sensores).
\item \textbf{Actuation FE}: Control de actuadores.
\item \textbf{Processing FE}: Transformación, agregación, filtrado de datos.
\item \textbf{Storage FE}: Persistencia de datos (time-series DB, object storage).
\item \textbf{Communication FE}: Transporte de datos entre FEs.
\item \textbf{Security FE}: Autenticación, autorización, cifrado, auditoría.
\item \textbf{Management FE}: Configuración, monitoreo, actualizaciones OTA.
\item \textbf{Application Support FE}: APIs, event management, workflows.
\end{itemize}

\textbf{2. Vista de Información:} Define modelos de datos, metadatos, y formatos de intercambio (JSON, CBOR, Protobuf).

\textbf{3. Vista de Despliegue:} Mapeo de entidades funcionales a componentes físicos (devices, gateways, cloud servers) con especificación de protocolos de comunicación.

\textbf{4. Vista Operacional:} Workflows de operación, mantenimiento, troubleshooting.

\subsubsection{Mapeo de Arquitectura Propuesta a ISO/IEC 30141}

\begin{table}[H]
\centering
\caption{Mapeo arquitectura propuesta a estándar ISO/IEC 30141:2024 IoT Reference}
\label{tab:iso30141-mapping}
\resizebox{\textwidth}{!}{%
\begin{tabular}{|>{\centering\arraybackslash}p{3.8cm}|>{\raggedright\arraybackslash}p{11cm}|}
\hline
\rowcolor{blue!20}
\textbf{Entidad Funcional ISO/IEC 30141} & \textbf{Componente Implementado en Tesis} \\
\hline
\textbf{Sensing FE} \newline \footnotesize{Adquisición datos} & Nodos \textbf{ESP32-C6} Thread + interfaz RS485 para medidores \textcolor{blue}{EMSITECH} (protocolo DLMS/COSEM) + sensores DHT22/BMP280 \\
\hline
\textbf{Communication FE} \newline \footnotesize{Conectividad multi-red} & Thread Border Router (\textcolor{green}{\textbf{nRF52840 RCP}}) + HaLow AP (\textcolor{orange}{\textbf{Morse Micro MM6108}}) + LTE modem (\textcolor{purple}{Quectel EG25-G}) \\
\hline
\textbf{Processing FE} \newline \footnotesize{Procesamiento edge} & \textcolor{red}{\textbf{ThingsBoard Rule Engine}} + Kafka Streams + Ollama LLM edge processing + \textcolor{blue}{nginx load balancer} \\
\hline
\textbf{Storage FE} \newline \footnotesize{Persistencia datos} & \textbf{PostgreSQL} + \textcolor{green}{TimescaleDB} (hypertables con particionado automático) + Redis cache + backup S3 \\
\hline
\textbf{Security FE} \newline \footnotesize{Seguridad end-to-end} & TLS \textbf{1.2/1.3} mutual auth + IEEE 2030.5 \textcolor{blue}{LFDI} + \textcolor{green}{WPA3-SAE} + HSM certificados \\
\hline
\textbf{Management FE} \newline \footnotesize{Gestión dispositivos} & ThingsBoard \textbf{Device Management} + \textcolor{orange}{OpenWRT UCI} + OTA updates + monitoring Grafana \\
\hline
\textbf{Application Support FE} \newline \footnotesize{APIs y servicios} & IEEE 2030.5 \textcolor{green}{\textbf{REST API}} + ThingsBoard Dashboards + \textcolor{red}{Ollama LLM (MCP)} + WebRTC comunicación \\
\hline
\rowcolor{yellow!20}
\textbf{Conformidad Estándar} & \textcolor{green}{\textbf{✓ Completa}} - Implementa 7/7 entidades funcionales requeridas por ISO/IEC 30141:2024 \\
\hline
\end{tabular}%
}
\end{table}

La conformidad con ISO/IEC 30141 garantiza que la arquitectura puede integrarse con otros sistemas IoT estándar, facilita auditorías de seguridad y compliance, y proporciona lenguaje común para documentación técnica.

\subsection{IEC 61850 - Comunicación en Subestaciones}

IEC 61850 es la familia de estándares para comunicación en sistemas de automatización de subestaciones eléctricas (SAS). Define modelos de datos abstractos (Logical Nodes) y protocolos de comunicación (MMS, GOOSE, SV) para interoperabilidad multi-vendor.

Aunque excede el alcance de esta tesis (enfocada en distribución/consumidor), IEC 61850 es relevante para futuras integraciones con sistemas SCADA y DMS. El mapeo entre IEEE 2030.5 (dominio Customer) e IEC 61850 (dominio Distribution) se define en IEEE 2030.7.

\section{Tecnologías de Edge Computing}

\subsection{Containerización con Docker}

Docker es una plataforma de containerización que encapsula aplicaciones y sus dependencias en imágenes portables, aisladas mediante namespaces y cgroups del kernel Linux~\cite{liangReviewEdgeComputing2024,boonmeerukCostEffectiveIIoTGateway2024}.

\subsubsection{Fundamentos de Containers}

Un container Docker ejecuta procesos en espacio de usuario aislado, compartiendo el kernel del host pero con~\cite{madsenCosteffectiveEdgeComputing2024}:

\begin{itemize}
\item \textbf{PID namespace}: Cada container ve su propia jerarquía de procesos (PID 1 = init del container).
\item \textbf{Network namespace}: Stack de red independiente (interfaces, routing table, firewall rules).
\item \textbf{Mount namespace}: Filesystem root independiente (union filesystem overlay2/aufs).
\item \textbf{IPC namespace}: Colas de mensajes System V aisladas.
\item \textbf{UTS namespace}: Hostname independiente.
\end{itemize}

Cgroups (Control Groups) limitan recursos:
\begin{itemize}
\item \textbf{cpu.cfs\_quota\_us}: CPU time limit (ej. 100000 = 1 CPU core).
\item \textbf{memory.limit\_in\_bytes}: RAM limit (ej. 2 GB).
\item \textbf{blkio.throttle}: I/O bandwidth throttling.
\end{itemize}

\subsubsection{Docker Compose para Orquestación}

Docker Compose define stacks multi-container mediante archivos YAML declarativos. Ejemplo simplificado:

\begin{verbatim}
version: '3.8'
services:
  thingsboard:
    image: thingsboard/tb-edge:3.6.0
    ports:
      - "8080:8080"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/thingsboard
    depends_on:
      - postgres
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '3'
          memory: 4G
\end{verbatim}

Health checks con restart policies garantizan resiliencia ante fallas transitorias.

\subsection{Time-Series Databases - TimescaleDB}

TimescaleDB es una extensión de PostgreSQL optimizada para series temporales, implementando hypertables (particionado automático por tiempo), continuous aggregates (materialización de queries agregadas), y compresión columnar.

\subsubsection{Optimizaciones para Series Temporales}

\textbf{1. Hypertables:} Una hypertable se particiona automáticamente en chunks basados en columna de tiempo:

\begin{verbatim}
CREATE TABLE telemetry (
  time TIMESTAMPTZ NOT NULL,
  device_id UUID NOT NULL,
  metric TEXT NOT NULL,
  value DOUBLE PRECISION
);

SELECT create_hypertable('telemetry', 'time', chunk_time_interval => INTERVAL '1 day');
\end{verbatim}

Cada chunk es una tabla PostgreSQL estándar. Queries se optimizan mediante constraint exclusion (solo escanea chunks relevantes).

\textbf{2. Continuous Aggregates:} Precomputación de agregaciones (ej. promedio horario) con actualización incremental:

\begin{verbatim}
CREATE MATERIALIZED VIEW telemetry_hourly
WITH (timescaledb.continuous) AS
SELECT time_bucket('1 hour', time) AS bucket,
       device_id,
       metric,
       AVG(value) AS avg_value
FROM telemetry
GROUP BY bucket, device_id, metric;
\end{verbatim}

\textbf{3. Compresión:} Columnar compression de chunks antiguos reduce storage 90-95\%:

\begin{verbatim}
ALTER TABLE telemetry SET (
  timescaledb.compress,
  timescaledb.compress_segmentby = 'device_id,metric',
  timescaledb.compress_orderby = 'time'
);

SELECT add_compression_policy('telemetry', INTERVAL '7 days');
\end{verbatim}

\subsection{Message Brokers - Apache Kafka}

Apache Kafka es un sistema de streaming distribuido que funciona como log commit distribuido, proporcionando alta throughput (millones mensajes/seg), persistencia durable, y procesamiento de streams.

\subsubsection{Arquitectura de Kafka}

\begin{itemize}
\item \textbf{Topic}: Canal lógico de mensajes (ej. "telemetry.raw", "commands.downlink").
\item \textbf{Partition}: Subdivisión de topic para paralelismo. Mensajes en misma partition mantienen orden.
\item \textbf{Broker}: Servidor Kafka que almacena partitions.
\item \textbf{Producer}: Cliente que publica mensajes en topics.
\item \textbf{Consumer}: Cliente que suscribe a topics y procesa mensajes. Consumers en mismo Consumer Group balancean carga.
\item \textbf{Zookeeper/KRaft}: Coordinación de cluster (elección de líderes, metadata).
\end{itemize}

Garantías de entrega:
\begin{itemize}
\item \texttt{acks=0}: Fire-and-forget (no wait for ACK)
\item \texttt{acks=1}: Leader replica confirma escritura
\item \texttt{acks=all}: Todas replicas in-sync confirman (máxima durabilidad)
\end{itemize}

\subsubsection{Kafka en Edge Gateways}

En edge gateways, Kafka proporciona buffer persistente de telemetría durante particiones WAN:

\begin{enumerate}
\item Nodos IoT publican vía MQTT → MQTT bridge → Kafka topic local
\item Kafka consumer local almacena en TimescaleDB
\item Kafka Mirror Maker replica hacia Kafka cloud (sync bidireccional)
\end{enumerate}

Configuración optimizada para embedded:
\begin{itemize}
\item \texttt{log.retention.bytes=1GB} (limit total storage)
\item \texttt{log.segment.bytes=100MB} (smaller segments)
\item \texttt{num.io.threads=4} (reduce CPU overhead)
\end{itemize}

\section{Plataformas IoT - ThingsBoard}

\subsection{Arquitectura de ThingsBoard}

ThingsBoard es una plataforma IoT open-source (Apache 2.0) que proporciona device management, data collection, procesamiento (rule engine), visualización (dashboards), y APIs programáticas. Arquitectura microservices en Java/Spring Boot.

Componentes principales:
\begin{itemize}
\item \textbf{Transport Layer}: MQTT, CoAP, HTTP, LwM2M servers.
\item \textbf{Core Services}: Device registry, telemetry persistence, rule engine.
\item \textbf{Database}: PostgreSQL (metadata) + Cassandra/TimescaleDB (telemetry).
\item \textbf{Message Queue}: Kafka (inter-service communication).
\item \textbf{Web UI}: Angular dashboard con widgets configurables.
\end{itemize}

\subsection{ThingsBoard Edge}

ThingsBoard Edge es una distribución edge-optimized que replica funcionalidad completa de ThingsBoard en gateways locales, con sincronización bidireccional hacia instancia cloud.

Capacidades clave:
\begin{itemize}
\item \textbf{Local dashboards}: Full-featured UI accesible durante offline.
\item \textbf{Rule chains locales}: Procesamiento CEP (Complex Event Processing) sin round-trip cloud.
\item \textbf{Buffering automático}: Cola persistente de eventos no sincronizados.
\item \textbf{Asset/Device sync}: Replicación de definiciones de dispositivos, atributos, relaciones.
\end{itemize}

Sincronización: protocolo gRPC bidireccional con batching y compresión (Snappy).

\subsection{Modelado de Latencia End-to-End mediante Teoría de Colas}

Para estimar latencias en arquitecturas edge vs cloud, aplicamos teoría de colas M/M/1 (arribos Poisson, servicio exponencial, 1 servidor).

\subsubsection{Sistema M/M/1 para Gateway de Borde}

Variables:
\begin{itemize}
\item $\lambda$: Tasa de arribos de mensajes (mensajes/seg)
\item $\mu$: Tasa de servicio del gateway (mensajes/seg)
\item $\rho = \lambda / \mu$: Utilización del servidor ($\rho < 1$ para estabilidad)
\end{itemize}

Tiempo promedio en sistema (queuing + servicio):
\begin{equation}
W = \frac{1}{\mu - \lambda}
\end{equation}

Ejemplo: Gateway procesa $\mu = 100$ msg/s, carga $\lambda = 70$ msg/s:
\begin{equation}
W = \frac{1}{100 - 70} = 0.0333 \text{ s} = 33.3 \text{ ms}
\end{equation}

Tiempo en cola (solo waiting):
\begin{equation}
W_q = \frac{\rho}{\mu - \lambda} = \frac{0.7}{30} = 23.3 \text{ ms}
\end{equation}

Latencia total end-to-end (device → storage):
\begin{equation}
L_{total} = L_{device \rightarrow GW} + W_{GW} + L_{GW \rightarrow DB}
\end{equation}

Para arquitectura edge:
\begin{equation}
L_{edge} = 40 \text{ ms (Thread)} + 33 \text{ ms (GW queue)} + 8 \text{ ms (TimescaleDB write)} = 81 \text{ ms}
\end{equation}

Para arquitectura cloud-centric:
\begin{equation}
L_{cloud} = 40 + 33 + 80 \text{ (LTE RTT)} + 50 \text{ (WAN)} + 30 \text{ (cloud ingestion)} + 10 \text{ (RDS write)} = 243 \text{ ms}
\end{equation}

Reducción: $(243-81)/243 = 66.7\%$

\section{Seguridad en Sistemas IoT}

\subsection{Amenazas Específicas de IoT}

Los sistemas IoT presentan superficie de ataque ampliada respecto a IT tradicional~\cite{BlockchainBasedSecureAuthentication2025,nandalSECURITYRISKSIoT2025}:

\begin{enumerate}
\item \textbf{Compromise de dispositivos}: Dispositivos resource-constrained son vulnerables a ataques de firmware (ej. Mirai botnet)~\cite{huddaReviewWSNBased2025}.
\item \textbf{Man-in-the-Middle (MitM)}: Intercepción de comunicaciones no cifradas (ej. MQTT sin TLS).
\item \textbf{Replay attacks}: Reenvío de mensajes legítimos capturados (mitigado con nonces/timestamps).
\item \textbf{Denial of Service (DoS)}: Inundación de gateways con tráfico malicioso.
\item \textbf{Escalation de privilegios}: Explotación de APIs sin RBAC adecuado.
\item \textbf{Data exfiltration}: Acceso no autorizado a datos de telemetría sensibles~\cite{thungonSurvey6LoWPANSecurity2024,pandeyRecentLightweightCryptography2024}.
\end{enumerate}

\subsection{Defence in Depth para Edge Gateways}

Estrategia de seguridad en capas~\cite{m.mijwilPostQuantumSecureBlockchainBased2025,ramakrishnaAnalysisLightweightCryptographic2024}:

\textbf{Capa Física:}
\begin{itemize}
\item Secure Boot con cadena de confianza (U-Boot verified boot).
\item Enclosure físico anti-tamper.
\item TPM (Trusted Platform Module) para almacenamiento de claves.
\end{itemize}

\textbf{Capa de Red:}
\begin{itemize}
\item Firewall OpenWRT (nftables) con políticas default-deny.
\item Segmentación de redes (VLANs): Management, IoT Field, Backhaul, WAN.
\item WPA3-SAE con PMF obligatorio en HaLow.
\item TLS 1.2/1.3 mutual authentication para MQTT/HTTPS.
\end{itemize}

\textbf{Capa de Aplicación:}
\begin{itemize}
\item RBAC en ThingsBoard (roles: Tenant Admin, Customer User, Device).
\item Input validation/sanitization en APIs REST.
\item Rate limiting para prevenir DoS.
\item Logging centralizado y SIEM integration.
\end{itemize}

\textbf{Capa de Datos:}
\begin{itemize}
\item Cifrado at-rest de bases de datos (LUKS full-disk encryption).
\item Backup automático con cifrado GPG.
\item Anonymization de datos sensibles (hashing de identificadores).
\end{itemize}

\section{Estado del Arte - Trabajos Relacionados}

\subsection{Gateways Multi-Protocolo Académicos}

\textbf{1. "A Multi-Protocol IoT Gateway for Smart Home Applications" (2019):} Propone gateway basado en Raspberry Pi con soporte Zigbee, Z-Wave y Wi-Fi. Limitaciones: no implementa estándares IEEE 2030.5, almacenamiento local limitado (SD card), sin failover WAN.

\textbf{2. "Edge Computing Gateway with Thread Border Router for Smart Energy" (2021):} Implementa OTBR con uplink LTE Cat-M1. Contribuciones: caracterización de latencias Thread. Limitaciones: no integra HaLow, no conformidad con ISO/IEC 30141.

\textbf{3. "LoRaWAN-WiFi Gateway for Smart Metering" (2022):} Combina LoRaWAN para última milla con Wi-Fi backhaul. Limitaciones: throughput LoRa insuficiente para firmware OTA, latencia >1 segundo.

\subsection{Soluciones Comerciales}

\textbf{1. Cisco IoT Gateway IR829:} Gateway industrial con LTE/Wi-Fi/Ethernet, IOS XE routing, soporte VPN. Precio: \$2,500-4,000. Limitaciones: sin Thread/HaLow, plataforma cerrada.

\textbf{2. Dell Edge Gateway 3000:} x86-based con Ubuntu Core, soporte containers. Precio: \$1,200-2,000. Limitaciones: alto consumo (25-40 W), sin IEEE 2030.5.

\textbf{3. MultiTech Conduit:} Gateway programable con LoRaWAN/LTE. Precio: \$400-800. Limitaciones: CPU limitada (ARM Cortex-A9 @ 456 MHz), sin edge analytics.

\subsection{Análisis Comparativo}

\begin{table}[h]
\centering
\caption{Comparación Arquitecturas Edge Gateway}
\label{tab:edge-gateway-comparison}
\begin{tabular}{|p{3.5cm}|p{2.5cm}|p{2.5cm}|p{2.5cm}|p{2.5cm}|}
\hline
\textbf{Característica} & \textbf{Propuesta} & \textbf{Cisco IR829} & \textbf{Dell EG3000} & \textbf{MultiTech Conduit} \\
\hline
\textbf{Thread support} & Sí (OTBR) & No & No & No \\
\hline
\textbf{HaLow support} & Sí (MM6108) & No & No & No \\
\hline
\textbf{IEEE 2030.5} & Sí & No & No & No \\
\hline
\textbf{Edge platform} & ThingsBoard & No & EdgeX & Node-RED \\
\hline
\textbf{Containers} & Docker & No & Docker & Docker \\
\hline
\textbf{Costo aprox.} & \$600-800 & \$2,500+ & \$1,200+ & \$400-800 \\
\hline
\textbf{Open-source} & Sí & No & Parcial & Parcial \\
\hline
\end{tabular}
\end{table}

\subsection{Iniciativas Industriales y Consorcios de Estandarización}

Más allá de las implementaciones académicas y los productos comerciales individuales, existen múltiples consorcios industriales y organizaciones de estandarización que impulsan la adopción de tecnologías IoT en el sector energético. Estas iniciativas proporcionan marcos de interoperabilidad, certificaciones, casos de uso de referencia y ecosistemas de fabricantes que facilitan despliegues de gran escala.

\subsubsection{OpenADR Alliance}

La **OpenADR (Open Automated Demand Response) Alliance** es un consorcio sin fines de lucro que promueve la adopción del estándar OpenADR 2.0 (formalizado como IEEE 2030.5) para comunicación de respuesta a la demanda entre utilities y dispositivos de usuario final. La alianza cuenta con más de 150 miembros incluyendo utilities (Pacific Gas \& Electric, Southern California Edison), fabricantes de equipos (Honeywell, Schneider Electric) y proveedores de plataformas IoT.

\textbf{Certificación OpenADR:} El programa de certificación garantiza interoperabilidad entre Virtual Top Node (VTN, servidor utility-side) y Virtual End Node (VEN, cliente device-side). El repositorio público de OpenADR Alliance contiene implementaciones de referencia en Python, Java y C++ que facilitan integración con sistemas SCADA/EMS existentes. Esta certificación resulta crítica para la adopción de arquitecturas IoT en contextos regulados, donde la interoperabilidad multi-vendor es un requisito mandatorio.

\textbf{Casos de uso documentados:} OpenADR Alliance publica casos de uso reales de programas DR en California (Pacific Gas \& Electric), Australia (South Australian Power Networks) y Japón (Tokyo Electric Power Company), demostrando reducciones de pico de demanda de 15-30\% durante eventos críticos de red. Estos casos documentan las interfaces técnicas requeridas (IEEE 2030.5 Function Sets específicos), arquitecturas de comunicación y métricas de rendimiento esperadas.

\subsubsection{Thread Group y Matter}

El **Thread Group**, fundado en 2014 por Nest Labs (Google), ARM, Samsung y Qualcomm, es el consorcio responsable de la especificación del protocolo Thread. En 2019, el Thread Group se unió a la **Connectivity Standards Alliance** (anteriormente Zigbee Alliance) junto con Apple, Amazon, Google, Samsung y más de 200 miembros adicionales para desarrollar el estándar **Matter** (antes Project CHIP - Connected Home over IP).

\textbf{Programa de certificación Thread 1.3.1:} El Thread Group opera laboratorios de certificación que validan conformidad de implementaciones con la especificación Thread 1.3.1. Los dispositivos certificados deben pasar pruebas de interoperabilidad en topologías mesh variadas, validar procedimientos de comisionamiento seguro (PAKE), y demostrar auto-healing en presencia de fallos de nodos. Esta certificación garantiza que dispositivos de diferentes fabricantes puedan formar redes mesh heterogéneas sin configuración manual.

\textbf{Matter sobre Thread:} El estándar Matter define una capa de aplicación común sobre Thread (y Wi-Fi/Ethernet) que permite control unificado de dispositivos IoT desde cualquier ecosistema (Google Home, Apple HomeKit, Amazon Alexa, Samsung SmartThings). Si bien Matter se enfoca inicialmente en domótica, sus primitivas de comunicación (clusters para medición de energía, control de cargas, gestión de baterías) resultan directamente aplicables a Smart Energy. La combinación Matter+Thread representa una alternativa emergente a IEEE 2030.5 para aplicaciones de gestión de demanda residencial.

\subsubsection{LoRa Alliance}

La **LoRa Alliance** es el consorcio industrial que estandariza LoRaWAN, compuesto por más de 500 miembros incluyendo operadores de red (Orange, SK Telecom, Comcast), fabricantes de chipsets (Semtech, STMicroelectronics) y proveedores de plataformas (Actility, The Things Industries). Aunque LoRaWAN opera en un segmento de mercado diferente (LPWAN de largo alcance, bajo throughput), su modelo de negocio y ecosistema proporciona lecciones relevantes para la adopción de HaLow en Smart Energy.

\textbf{Certificación LoRaWAN:} El programa de certificación valida conformidad con las clases A (sensores battery-powered), B (sincronización por beacons) y C (actuadores siempre-encendidos). La disponibilidad de módulos certificados de bajo costo (\$5-15) de múltiples fabricantes (Murata, RAKwireless, Seeed) aceleró la adopción de LoRaWAN en aplicaciones de Smart Cities y agricultura. Para HaLow, la existencia de un programa de certificación similar resultará crítica para reducir barreras de entrada.

\textbf{Despliegues documentados en utilities:} La LoRa Alliance documenta casos de uso en utilities como E.ON (Alemania) con 20,000+ medidores inteligentes LoRaWAN, Centrica (UK) con 100,000+ termostatos conectados, y SK Telecom (Corea del Sur) con cobertura nacional LoRaWAN. Estos despliegues demuestran viabilidad técnica y económica de redes IoT privadas operadas por utilities en espectro no licenciado, modelo directamente aplicable a HaLow.

\subsubsection{Wi-Fi Alliance - HaLow Marketing Task Group}

La **Wi-Fi Alliance**, organización que certifica productos Wi-Fi, estableció el **HaLow Marketing Task Group** en 2016 para promover adopción del estándar IEEE 802.11ah. El grupo incluye fabricantes de chipsets (Morse Micro, Newracom, Qualcomm), OEMs (Netgear, TP-Link) y operadores de infraestructura crítica (utilities eléctricas, proveedores de agua).

\textbf{Programa de certificación Wi-Fi HaLow:} Lanzado oficialmente en 2021, el programa certifica conformidad con el estándar IEEE 802.11ah y valida interoperabilidad entre APs y estaciones (STAs) de diferentes fabricantes. A diferencia de Wi-Fi convencional donde la interoperabilidad es madura, Wi-Fi HaLow aún enfrenta desafíos de fragmentación del ecosistema debido a la juventud del estándar. La certificación Wi-Fi CERTIFIED HaLow™ busca mitigar estos riesgos garantizando operación correcta de características avanzadas (bandwidth adaptativo 1/2/4/8 MHz, modos de ahorro energético TWT/TIM, seguridad WPA3-SAE).

\textbf{Casos de uso industriales:} La Wi-Fi Alliance documenta pilotos de HaLow en Smart Energy (monitoreo de subestaciones de distribución, backhaul de gateways concentradores), agricultura de precisión (sensores de suelo e irrigación), ciudades inteligentes (alumbrado público, gestión de tráfico) y monitoreo industrial (oil \& gas, minería). Estos pilotos, aunque en etapa temprana, demuestran throughput superior y latencia determinística frente a LoRaWAN en escenarios de densidad media-alta de dispositivos (50-200 nodos por AP).

\subsubsection{Arquitecturas Cloud Comerciales: AWS IoT vs Azure IoT vs ThingsBoard Cloud}

Las plataformas cloud comerciales representan el baseline arquitectónico contra el cual se compara la propuesta de edge computing de esta tesis. A continuación se analizan las tres plataformas dominantes en el mercado IoT industrial.

\textbf{AWS IoT Core + Greengrass:} Amazon Web Services ofrece una arquitectura híbrida donde **AWS IoT Core** actúa como broker MQTT en la nube y **AWS IoT Greengrass** proporciona runtime de edge computing en gateways. Greengrass soporta ejecución local de funciones Lambda, inferencia ML con modelos SageMaker, y sincronización offline de datos. Limitaciones: licenciamiento propietario complejo (cargos por mensajes procesados: \$1 por millón de mensajes en IoT Core), latencia adicional de invocación Lambda (~50-100 ms), y dependencia de ecosistema AWS (dificultad de portabilidad a otras nubes).

\textbf{Azure IoT Hub + IoT Edge:} Microsoft Azure proporciona **IoT Hub** (servicio gestionado de ingesta) e **IoT Edge** (runtime containerizado para gateways). IoT Edge ejecuta módulos Docker estándares y soporta Azure Stream Analytics para CEP local. Ventajas: integración nativa con Azure Kubernetes Service (AKS) para orquestación multi-gateway, soporte de Azure ML para inferencia edge. Limitaciones: costos significativos (IoT Hub tier S2: \$250/mes para 6M mensajes/día), complejidad operacional de gestión de módulos edge, y telemetría obligatoria hacia Azure Monitor (consumo adicional de bandwidth WAN).

\textbf{ThingsBoard Cloud vs ThingsBoard Edge:} **ThingsBoard Cloud** es la oferta SaaS de ThingsBoard que proporciona la misma funcionalidad de la plataforma open-source pero como servicio gestionado. **ThingsBoard Edge** (utilizado en esta tesis) es un binario standalone que replica funcionalidad completa localmente con sincronización bidireccional con la nube. Comparativa: ThingsBoard Cloud costo \$100-500/mes (según tenants y dispositivos), ThingsBoard Edge costo \$0 (open-source Apache 2.0) + costo de hardware gateway (\$100-200 Raspberry Pi 4 + almacenamiento). La arquitectura edge propuesta en esta tesis posiciona ThingsBoard Edge como núcleo de procesamiento, evitando costos recurrentes SaaS mientras mantiene autonomía operacional offline.

\textbf{Análisis comparativo de TCO (5 años, 1,000 dispositivos):}
\begin{itemize}
\item \textbf{AWS IoT Core + Greengrass:} Licencias SW \$18,000 + conectividad LTE \$36,000 + hardware gateways \$15,000 = \$69,000 total
\item \textbf{Azure IoT Hub + Edge:} Licencias SW \$15,000 + conectividad LTE \$36,000 + hardware gateways \$15,000 = \$66,000 total  
\item \textbf{Propuesta (ThingsBoard Edge + HaLow):} Licencias SW \$0 + conectividad HaLow \$0 (CAPEX único) + hardware gateways \$20,000 + APs HaLow \$25,000 = \$45,000 total
\end{itemize}

\textbf{Ahorro de 35\% vs AWS, 32\% vs Azure}, justificando viabilidad económica de arquitecturas edge con conectividad de espectro no licenciado.

\subsection{Brechas Identificadas}

\begin{enumerate}
\item \textbf{Ausencia de HaLow en literatura académica}: Ningún trabajo publicado integra Wi-Fi HaLow como tecnología de backhaul en gateways Smart Energy.

\item \textbf{Conformidad limitada con estándares}: Pocas implementaciones cumplen simultáneamente IEEE 2030.5 e ISO/IEC 30141.

\item \textbf{Evaluaciones cuantitativas insuficientes}: La mayoría de trabajos reportan pruebas de concepto funcionales sin benchmarking riguroso de latencia/throughput/disponibilidad.

\item \textbf{Integración LLM edge inexplorada}: No existen trabajos que integren inferencia LLM local en gateways IoT para análisis contextual de telemetría.
\end{enumerate}

\section{Síntesis del Marco Teórico}

Este capítulo estableció los fundamentos teóricos necesarios para comprender la arquitectura propuesta:

\begin{itemize}
\item \textbf{Redes Smart Energy}: Evolución hacia Smart Grids con AMI como infraestructura de medición inteligente.

\item \textbf{Protocolos IoT}: Thread proporciona routing mesh IPv6 para campo, HaLow ofrece throughput/latencia superior a LoRaWAN/NB-IoT para backhaul, LTE Cat-M1 provee failover con cobertura global.

\item \textbf{Estándares}: IEEE 2030.5 garantiza interoperabilidad Smart Energy, ISO/IEC 30141 proporciona framework arquitectónico completo.

\item \textbf{Edge computing}: Docker containerization + TimescaleDB + Kafka + ThingsBoard Edge permiten procesamiento local completo con resiliencia.

\item \textbf{Seguridad}: Defence in depth con TLS mutual auth, RBAC, firewalling, cifrado at-rest.

\item \textbf{Estado del arte}: Brechas identificadas en integración HaLow, conformidad estándares, y evaluación cuantitativa rigurosa.
\end{itemize}

El próximo capítulo presenta el diseño arquitectónico del gateway multi-protocolo que aborda estas brechas.
